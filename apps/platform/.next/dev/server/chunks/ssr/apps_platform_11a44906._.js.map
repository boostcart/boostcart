{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/lib/rbac.ts"],"sourcesContent":["import type { StaffRole } from \"@boostcart/database\";\n\n/**\n * Permission definitions for the BoostCart admin dashboard\n *\n * Role Hierarchy:\n * - OWNER: Full access, can manage staff, billing, delete store\n * - ADMIN: Almost full access, can manage most settings\n * - MANAGER: Can manage products, orders, customers, content\n * - SUPPORT: Can view and manage orders, customers (read-only products)\n * - VIEWER: Read-only access to everything\n */\n\nexport type Permission =\n\t// Navigation / Page Access\n\t| \"dashboard:view\"\n\t| \"orders:view\"\n\t| \"orders:manage\"\n\t| \"orders:delete\"\n\t| \"products:view\"\n\t| \"products:manage\"\n\t| \"products:delete\"\n\t| \"categories:view\"\n\t| \"categories:manage\"\n\t| \"collections:view\"\n\t| \"collections:manage\"\n\t| \"brands:view\"\n\t| \"brands:manage\"\n\t| \"gift-cards:view\"\n\t| \"gift-cards:manage\"\n\t| \"customers:view\"\n\t| \"customers:manage\"\n\t| \"customers:delete\"\n\t| \"content:view\"\n\t| \"content:manage\"\n\t| \"files:view\"\n\t| \"files:manage\"\n\t| \"discounts:view\"\n\t| \"discounts:manage\"\n\t| \"promo-codes:view\"\n\t| \"promo-codes:manage\"\n\t| \"reviews:view\"\n\t| \"reviews:manage\"\n\t| \"analytics:view\"\n\t// Settings\n\t| \"settings:view\"\n\t| \"settings:manage\"\n\t| \"locales:view\"\n\t| \"locales:manage\"\n\t| \"payments:view\"\n\t| \"payments:manage\"\n\t| \"shipping:view\"\n\t| \"shipping:manage\"\n\t// Staff management\n\t| \"staff:view\"\n\t| \"staff:manage\"\n\t| \"staff:delete\"\n\t// Billing & Store\n\t| \"billing:view\"\n\t| \"billing:manage\"\n\t| \"store:delete\";\n\n/**\n * Permission matrix: defines which permissions each role has\n */\nconst ROLE_PERMISSIONS: Record<StaffRole, Permission[]> = {\n\tOWNER: [\n\t\t// Full access to everything\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"orders:delete\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"products:delete\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"customers:delete\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"settings:manage\",\n\t\t\"locales:view\",\n\t\t\"locales:manage\",\n\t\t\"payments:view\",\n\t\t\"payments:manage\",\n\t\t\"shipping:view\",\n\t\t\"shipping:manage\",\n\t\t\"staff:view\",\n\t\t\"staff:manage\",\n\t\t\"staff:delete\",\n\t\t\"billing:view\",\n\t\t\"billing:manage\",\n\t\t\"store:delete\",\n\t],\n\n\tADMIN: [\n\t\t// Almost full access, except billing management and store deletion\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"orders:delete\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"products:delete\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"customers:delete\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"settings:manage\",\n\t\t\"locales:view\",\n\t\t\"locales:manage\",\n\t\t\"payments:view\",\n\t\t\"payments:manage\",\n\t\t\"shipping:view\",\n\t\t\"shipping:manage\",\n\t\t\"staff:view\",\n\t\t\"staff:manage\",\n\t\t\"billing:view\",\n\t],\n\n\tMANAGER: [\n\t\t// Can manage products, orders, customers, content\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"locales:view\",\n\t\t\"payments:view\",\n\t\t\"shipping:view\",\n\t],\n\n\tSUPPORT: [\n\t\t// Can view most things, manage orders and customers only\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"products:view\",\n\t\t\"categories:view\",\n\t\t\"collections:view\",\n\t\t\"brands:view\",\n\t\t\"gift-cards:view\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"content:view\",\n\t\t\"files:view\",\n\t\t\"discounts:view\",\n\t\t\"promo-codes:view\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t],\n\n\tVIEWER: [\n\t\t// Read-only access\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"products:view\",\n\t\t\"categories:view\",\n\t\t\"collections:view\",\n\t\t\"brands:view\",\n\t\t\"gift-cards:view\",\n\t\t\"customers:view\",\n\t\t\"content:view\",\n\t\t\"files:view\",\n\t\t\"discounts:view\",\n\t\t\"promo-codes:view\",\n\t\t\"reviews:view\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"locales:view\",\n\t\t\"payments:view\",\n\t\t\"shipping:view\",\n\t],\n};\n\n/**\n * Check if a role has a specific permission\n */\nexport function hasPermission(\n\trole: StaffRole | string | null,\n\tpermission: Permission\n): boolean {\n\tif (!role) return false;\n\tconst permissions = ROLE_PERMISSIONS[role as StaffRole];\n\tif (!permissions) return false;\n\treturn permissions.includes(permission);\n}\n\n/**\n * Check if a role has any of the specified permissions\n */\nexport function hasAnyPermission(\n\trole: StaffRole | string | null,\n\tpermissions: Permission[]\n): boolean {\n\treturn permissions.some((permission) => hasPermission(role, permission));\n}\n\n/**\n * Check if a role has all of the specified permissions\n */\nexport function hasAllPermissions(\n\trole: StaffRole | string | null,\n\tpermissions: Permission[]\n): boolean {\n\treturn permissions.every((permission) => hasPermission(role, permission));\n}\n\n/**\n * Get all permissions for a role\n */\nexport function getPermissions(role: StaffRole | string | null): Permission[] {\n\tif (!role) return [];\n\treturn ROLE_PERMISSIONS[role as StaffRole] || [];\n}\n\n/**\n * Check if role can manage (create/edit/delete) a resource\n */\nexport function canManage(\n\trole: StaffRole | string | null,\n\tresource:\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): boolean {\n\treturn hasPermission(role, `${resource}:manage` as Permission);\n}\n\n/**\n * Check if role can view a resource\n */\nexport function canView(\n\trole: StaffRole | string | null,\n\tresource:\n\t\t| \"dashboard\"\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"analytics\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): boolean {\n\treturn hasPermission(role, `${resource}:view` as Permission);\n}\n\n/**\n * Check if role can delete a resource\n */\nexport function canDelete(\n\trole: StaffRole | string | null,\n\tresource: \"orders\" | \"products\" | \"customers\" | \"staff\" | \"store\"\n): boolean {\n\treturn hasPermission(role, `${resource}:delete` as Permission);\n}\n\n/**\n * Role hierarchy for comparison\n * Higher number = more authority\n */\nconst ROLE_HIERARCHY: Record<StaffRole, number> = {\n\tOWNER: 100,\n\tADMIN: 80,\n\tMANAGER: 60,\n\tSUPPORT: 40,\n\tVIEWER: 20,\n};\n\n/**\n * Check if roleA has higher or equal authority than roleB\n */\nexport function hasHigherOrEqualAuthority(\n\troleA: StaffRole | string | null,\n\troleB: StaffRole | string | null\n): boolean {\n\tif (!roleA || !roleB) return false;\n\tconst levelA = ROLE_HIERARCHY[roleA as StaffRole] || 0;\n\tconst levelB = ROLE_HIERARCHY[roleB as StaffRole] || 0;\n\treturn levelA >= levelB;\n}\n\n/**\n * Get display name for a role\n */\nexport function getRoleDisplayName(role: StaffRole | string | null): string {\n\tswitch (role) {\n\t\tcase \"OWNER\":\n\t\t\treturn \"Owner\";\n\t\tcase \"ADMIN\":\n\t\t\treturn \"Administrator\";\n\t\tcase \"MANAGER\":\n\t\t\treturn \"Manager\";\n\t\tcase \"SUPPORT\":\n\t\t\treturn \"Support\";\n\t\tcase \"VIEWER\":\n\t\t\treturn \"Viewer\";\n\t\tdefault:\n\t\t\treturn \"Unknown\";\n\t}\n}\n\n/**\n * Get role description\n */\nexport function getRoleDescription(role: StaffRole | string | null): string {\n\tswitch (role) {\n\t\tcase \"OWNER\":\n\t\t\treturn \"Full access to everything including billing and staff management\";\n\t\tcase \"ADMIN\":\n\t\t\treturn \"Manage all store operations except billing\";\n\t\tcase \"MANAGER\":\n\t\t\treturn \"Manage products, orders, customers, and content\";\n\t\tcase \"SUPPORT\":\n\t\t\treturn \"Handle customer orders and inquiries\";\n\t\tcase \"VIEWER\":\n\t\t\treturn \"View-only access to store data\";\n\t\tdefault:\n\t\t\treturn \"Unknown role\";\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AA8DA;;CAEC,GACD,MAAM,mBAAoD;IACzD,OAAO;QACN,4BAA4B;QAC5B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,OAAO;QACN,mEAAmE;QACnE;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,SAAS;QACR,kDAAkD;QAClD;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,SAAS;QACR,yDAAyD;QACzD;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,QAAQ;QACP,mBAAmB;QACnB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;AACF;AAKO,SAAS,cACf,IAA+B,EAC/B,UAAsB;IAEtB,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,cAAc,gBAAgB,CAAC,KAAkB;IACvD,IAAI,CAAC,aAAa,OAAO;IACzB,OAAO,YAAY,QAAQ,CAAC;AAC7B;AAKO,SAAS,iBACf,IAA+B,EAC/B,WAAyB;IAEzB,OAAO,YAAY,IAAI,CAAC,CAAC,aAAe,cAAc,MAAM;AAC7D;AAKO,SAAS,kBACf,IAA+B,EAC/B,WAAyB;IAEzB,OAAO,YAAY,KAAK,CAAC,CAAC,aAAe,cAAc,MAAM;AAC9D;AAKO,SAAS,eAAe,IAA+B;IAC7D,IAAI,CAAC,MAAM,OAAO,EAAE;IACpB,OAAO,gBAAgB,CAAC,KAAkB,IAAI,EAAE;AACjD;AAKO,SAAS,UACf,IAA+B,EAC/B,QAkBY;IAEZ,OAAO,cAAc,MAAM,GAAG,SAAS,OAAO,CAAC;AAChD;AAKO,SAAS,QACf,IAA+B,EAC/B,QAoBY;IAEZ,OAAO,cAAc,MAAM,GAAG,SAAS,KAAK,CAAC;AAC9C;AAKO,SAAS,UACf,IAA+B,EAC/B,QAAiE;IAEjE,OAAO,cAAc,MAAM,GAAG,SAAS,OAAO,CAAC;AAChD;AAEA;;;CAGC,GACD,MAAM,iBAA4C;IACjD,OAAO;IACP,OAAO;IACP,SAAS;IACT,SAAS;IACT,QAAQ;AACT;AAKO,SAAS,0BACf,KAAgC,EAChC,KAAgC;IAEhC,IAAI,CAAC,SAAS,CAAC,OAAO,OAAO;IAC7B,MAAM,SAAS,cAAc,CAAC,MAAmB,IAAI;IACrD,MAAM,SAAS,cAAc,CAAC,MAAmB,IAAI;IACrD,OAAO,UAAU;AAClB;AAKO,SAAS,mBAAmB,IAA+B;IACjE,OAAQ;QACP,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR;YACC,OAAO;IACT;AACD;AAKO,SAAS,mBAAmB,IAA+B;IACjE,OAAQ;QACP,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR;YACC,OAAO;IACT;AACD"}},
    {"offset": {"line": 271, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/permissions.ts"],"sourcesContent":["\"use server\";\n\nimport { db } from \"@/server/db\";\nimport { auth } from \"@/server/auth\";\nimport { headers } from \"next/headers\";\nimport type { StaffRole } from \"@boostcart/database\";\nimport {\n\thasPermission,\n\thasAnyPermission,\n\thasAllPermissions,\n\tcanManage,\n\tcanView,\n\tcanDelete,\n\ttype Permission,\n} from \"@/lib/rbac\";\n\ninterface StaffContext {\n\tuserId: string;\n\ttenantId: string;\n\trole: StaffRole;\n}\n\n/**\n * Get the current staff context (user, tenant, role)\n * Throws an error if the user is not authenticated or not a staff member\n */\nexport async function getStaffContext(): Promise<StaffContext> {\n\tconst session = await auth();\n\n\tif (!session?.user?.id) {\n\t\tthrow new Error(\"Unauthorized: Not authenticated\");\n\t}\n\n\t// Get tenant from header (set by proxy)\n\tconst headersList = await headers();\n\tconst tenantSlug = headersList.get(\"x-tenant-slug\");\n\n\tif (!tenantSlug) {\n\t\tthrow new Error(\"Unauthorized: No tenant context\");\n\t}\n\n\t// Get the tenant\n\tconst tenant = await db.tenant.findUnique({\n\t\twhere: { slug: tenantSlug },\n\t\tselect: { id: true },\n\t});\n\n\tif (!tenant) {\n\t\tthrow new Error(\"Unauthorized: Tenant not found\");\n\t}\n\n\t// Get staff record\n\tconst staff = await db.tenantStaff.findFirst({\n\t\twhere: {\n\t\t\tuserId: session.user.id,\n\t\t\ttenantId: tenant.id,\n\t\t},\n\t\tselect: {\n\t\t\trole: true,\n\t\t},\n\t});\n\n\tif (!staff) {\n\t\tthrow new Error(\"Unauthorized: Not a staff member of this tenant\");\n\t}\n\n\treturn {\n\t\tuserId: session.user.id,\n\t\ttenantId: tenant.id,\n\t\trole: staff.role,\n\t};\n}\n\n/**\n * Require a specific permission to continue\n * Throws an error if the user doesn't have the required permission\n */\nexport async function requirePermission(permission: Permission): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasPermission(context.role, permission)) {\n\t\tthrow new Error(`Forbidden: Missing permission '${permission}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require any of the specified permissions\n */\nexport async function requireAnyPermission(permissions: Permission[]): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasAnyPermission(context.role, permissions)) {\n\t\tthrow new Error(`Forbidden: Missing required permissions`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require all of the specified permissions\n */\nexport async function requireAllPermissions(permissions: Permission[]): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasAllPermissions(context.role, permissions)) {\n\t\tthrow new Error(`Forbidden: Missing required permissions`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to manage a resource\n */\nexport async function requireManagePermission(\n\tresource:\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canManage(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot manage '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to view a resource\n */\nexport async function requireViewPermission(\n\tresource:\n\t\t| \"dashboard\"\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"analytics\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canView(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot view '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to delete a resource\n */\nexport async function requireDeletePermission(\n\tresource: \"orders\" | \"products\" | \"customers\" | \"staff\" | \"store\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canDelete(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot delete '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Check if current user has a permission (doesn't throw)\n */\nexport async function checkPermission(permission: Permission): Promise<boolean> {\n\ttry {\n\t\tconst context = await getStaffContext();\n\t\treturn hasPermission(context.role, permission);\n\t} catch {\n\t\treturn false;\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 423, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/internal/orders.ts"],"sourcesContent":["\"use server\";\n\nimport type { OrderStatus, PaymentStatus } from \"@boostcart/database\";\nimport { db } from \"@/server/db\";\nimport {\n\trequireViewPermission,\n\trequireManagePermission,\n} from \"@/server/api/permissions\";\n\nasync function requireOrderViewAccess() {\n\treturn await requireViewPermission(\"orders\");\n}\n\nasync function requireOrderManageAccess() {\n\treturn await requireManagePermission(\"orders\");\n}\n\nexport async function getOrders() {\n\tconst { tenantId } = await requireOrderViewAccess();\n\n\tconst orders = await db.order.findMany({\n\t\twhere: { tenantId },\n\t\tinclude: {\n\t\t\tcustomer: true,\n\t\t\titems: {\n\t\t\t\tinclude: {\n\t\t\t\t\tselectedVariant: true,\n\t\t\t\t\tproduct: true,\n\t\t\t\t},\n\t\t\t},\n\t\t\tshippingMethod: true,\n\t\t\tpaymentMethod: true,\n\t\t},\n\t\torderBy: { createdAt: \"desc\" },\n\t});\n\n\treturn orders;\n}\n\nexport async function getOrder(id: string) {\n\tconst { tenantId } = await requireOrderViewAccess();\n\n\tconst order = await db.order.findFirst({\n\t\twhere: { id, tenantId },\n\t\tinclude: {\n\t\t\tcustomer: true,\n\t\t\titems: {\n\t\t\t\tinclude: {\n\t\t\t\t\tselectedVariant: true,\n\t\t\t\t\tproduct: true,\n\t\t\t\t},\n\t\t\t},\n\t\t\tshippingMethod: true,\n\t\t\tpaymentMethod: true,\n\t\t\thistory: true,\n\t\t\ttenant: true,\n\t\t},\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found\");\n\t}\n\n\treturn order;\n}\n\nexport async function updateOrderStatus(orderId: string, status: OrderStatus) {\n\tconst { tenantId } = await requireOrderManageAccess();\n\n\t// Verify order belongs to tenant\n\tconst order = await db.order.findFirst({\n\t\twhere: { id: orderId, tenantId },\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found or access denied\");\n\t}\n\n\tconst updated = await db.order.update({\n\t\twhere: { id: orderId },\n\t\tdata: { status },\n\t});\n\n\treturn updated;\n}\n\nexport async function updatePaymentStatus(\n\torderId: string,\n\tpaymentStatus: PaymentStatus,\n) {\n\tconst { tenantId } = await requireOrderManageAccess();\n\n\t// Verify order belongs to tenant\n\tconst order = await db.order.findFirst({\n\t\twhere: { id: orderId, tenantId },\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found or access denied\");\n\t}\n\n\tconst updated = await db.order.update({\n\t\twhere: { id: orderId },\n\t\tdata: { paymentStatus },\n\t});\n\n\treturn updated;\n}\n\nexport async function addOrderNote(orderId: string, note: string) {\n\tconst { tenantId, userId } = await requireOrderManageAccess();\n\n\t// Verify order belongs to tenant\n\tconst order = await db.order.findFirst({\n\t\twhere: { id: orderId, tenantId },\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found or access denied\");\n\t}\n\n\t// Add note to order history instead\n\tconst historyEntry = await db.orderHistory.create({\n\t\tdata: {\n\t\t\torderId,\n\t\t\tstatus: order.status,\n\t\t\tnotes: note,\n\t\t\tuserId,\n\t\t},\n\t});\n\n\treturn historyEntry;\n}\n\nexport async function cancelOrder(orderId: string, reason?: string) {\n\tconst { tenantId, userId } = await requireOrderManageAccess();\n\n\t// Verify order belongs to tenant\n\tconst order = await db.order.findFirst({\n\t\twhere: { id: orderId, tenantId },\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found or access denied\");\n\t}\n\n\tconst updated = await db.order.update({\n\t\twhere: { id: orderId },\n\t\tdata: {\n\t\t\tstatus: \"CANCELLED\",\n\t\t\tcancelledAt: new Date(),\n\t\t},\n\t});\n\n\t// Add cancellation reason to history\n\tif (reason) {\n\t\tawait db.orderHistory.create({\n\t\t\tdata: {\n\t\t\t\torderId,\n\t\t\t\tstatus: \"CANCELLED\",\n\t\t\t\tnotes: `Cancellation reason: ${reason}`,\n\t\t\t\tuserId,\n\t\t\t},\n\t\t});\n\t}\n\n\treturn updated;\n}\n\nexport async function fulfillOrder(\n\torderId: string,\n\ttrackingNumber?: string,\n\ttrackingUrl?: string,\n) {\n\tconst { tenantId, userId } = await requireOrderManageAccess();\n\n\t// Verify order belongs to tenant\n\tconst order = await db.order.findFirst({\n\t\twhere: { id: orderId, tenantId },\n\t});\n\n\tif (!order) {\n\t\tthrow new Error(\"Order not found or access denied\");\n\t}\n\n\tconst updated = await db.order.update({\n\t\twhere: { id: orderId },\n\t\tdata: {\n\t\t\tstatus: \"DELIVERED\",\n\t\t},\n\t});\n\n\t// Add fulfillment info to history\n\tawait db.orderHistory.create({\n\t\tdata: {\n\t\t\torderId,\n\t\t\tstatus: \"DELIVERED\",\n\t\t\tnotes: trackingNumber\n\t\t\t\t? `Tracking: ${trackingNumber}${trackingUrl ? ` - ${trackingUrl}` : \"\"}`\n\t\t\t\t: undefined,\n\t\t\tuserId,\n\t\t},\n\t});\n\n\treturn updated;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 662, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/.next-internal/server/app/%28internal%29/admin/orders/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getUserStores as '003bfcd7ac293af20dc22123ec44e81263e2c95347'} from 'ACTIONS_MODULE0'\nexport {userHasStore as '00b865bde8853c0b2200356e8a44aabbfda99ded8f'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {createStore as '40177cd97a285945b21e6d3751ddbdc14238608821'} from 'ACTIONS_MODULE0'\nexport {checkSlugAvailability as '40ece7c8b327f75aed046925634f22b2bd96f4eb54'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {getOrders as '0018caf7ecfc73ca43f40bb67967bd0ec4f22ee255'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAMA"}}]
}