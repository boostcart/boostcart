{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/lib/tenant.ts"],"sourcesContent":["import { db } from \"@/server/db\";\nimport type { Tenant } from \"@boostcart/database\";\n\n// Cache for tenant lookups\nconst tenantCache = new Map<string, { tenant: Tenant; expiry: number }>();\nconst CACHE_TTL = 60 * 1000; // 1 minute\n\n/**\n * Get tenant by subdomain (slug)\n */\nexport async function getTenantBySlug(slug: string): Promise<Tenant | null> {\n\t// Check cache first\n\tconst cached = tenantCache.get(`slug:${slug}`);\n\tif (cached && cached.expiry > Date.now()) {\n\t\treturn cached.tenant;\n\t}\n\n\tconst tenant = await db.tenant.findFirst({\n\t\twhere: {\n\t\t\tslug,\n\t\t\tisActive: true,\n\t\t\tdeletedAt: null,\n\t\t},\n\t});\n\n\tif (tenant) {\n\t\ttenantCache.set(`slug:${slug}`, {\n\t\t\ttenant,\n\t\t\texpiry: Date.now() + CACHE_TTL,\n\t\t});\n\t}\n\n\treturn tenant;\n}\n\n/**\n * Get tenant by custom domain\n */\nexport async function getTenantByDomain(domain: string): Promise<Tenant | null> {\n\t// Check cache first\n\tconst cached = tenantCache.get(`domain:${domain}`);\n\tif (cached && cached.expiry > Date.now()) {\n\t\treturn cached.tenant;\n\t}\n\n\tconst tenantDomain = await db.tenantDomain.findFirst({\n\t\twhere: {\n\t\t\tdomain,\n\t\t\tdnsVerified: true,\n\t\t},\n\t\tinclude: {\n\t\t\ttenant: true,\n\t\t},\n\t});\n\n\tif (tenantDomain?.tenant && tenantDomain.tenant.isActive) {\n\t\ttenantCache.set(`domain:${domain}`, {\n\t\t\ttenant: tenantDomain.tenant,\n\t\t\texpiry: Date.now() + CACHE_TTL,\n\t\t});\n\t\treturn tenantDomain.tenant;\n\t}\n\n\treturn null;\n}\n\n/**\n * Extract tenant from request hostname\n */\nexport async function getTenantFromRequest(\n\thostname: string | null\n): Promise<Tenant | null> {\n\tif (!hostname) return null;\n\n\t// Remove port if present\n\tconst host = hostname.split(\":\")[0];\n\tif (!host) return null;\n\n\t// Check if it's the main platform domain\n\tconst platformDomains = [\"boostcart.bg\", \"localhost\", \"127.0.0.1\"];\n\tconst isMainDomain = platformDomains.some(\n\t\t(d) => host === d || host === `www.${d}`\n\t);\n\n\tif (isMainDomain) {\n\t\t// No tenant for main domain\n\t\treturn null;\n\t}\n\n\t// Check for subdomain (e.g., store.boostcart.bg)\n\tconst subdomainMatch = host.match(/^([a-z0-9-]+)\\.boostcart\\.bg$/i);\n\tif (subdomainMatch?.[1]) {\n\t\tconst slug = subdomainMatch[1];\n\t\t// Skip common subdomains\n\t\tif ([\"www\", \"api\", \"admin\", \"staging\", \"dev\"].includes(slug)) {\n\t\t\treturn null;\n\t\t}\n\t\treturn getTenantBySlug(slug);\n\t}\n\n\t// Check for local dev subdomain (e.g., store.localhost)\n\tconst localSubdomainMatch = host.match(/^([a-z0-9-]+)\\.localhost$/i);\n\tif (localSubdomainMatch?.[1]) {\n\t\treturn getTenantBySlug(localSubdomainMatch[1]);\n\t}\n\n\t// Otherwise, check if it's a custom domain\n\treturn getTenantByDomain(host);\n}\n\n/**\n * Clear tenant cache (useful after updates)\n */\nexport function clearTenantCache(identifier?: string) {\n\tif (identifier) {\n\t\ttenantCache.delete(`slug:${identifier}`);\n\t\ttenantCache.delete(`domain:${identifier}`);\n\t} else {\n\t\ttenantCache.clear();\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAGA,2BAA2B;AAC3B,MAAM,cAAc,IAAI;AACxB,MAAM,YAAY,KAAK,MAAM,WAAW;AAKjC,eAAe,gBAAgB,IAAY;IACjD,oBAAoB;IACpB,MAAM,SAAS,YAAY,GAAG,CAAC,CAAC,KAAK,EAAE,MAAM;IAC7C,IAAI,UAAU,OAAO,MAAM,GAAG,KAAK,GAAG,IAAI;QACzC,OAAO,OAAO,MAAM;IACrB;IAEA,MAAM,SAAS,MAAM,6IAAE,CAAC,MAAM,CAAC,SAAS,CAAC;QACxC,OAAO;YACN;YACA,UAAU;YACV,WAAW;QACZ;IACD;IAEA,IAAI,QAAQ;QACX,YAAY,GAAG,CAAC,CAAC,KAAK,EAAE,MAAM,EAAE;YAC/B;YACA,QAAQ,KAAK,GAAG,KAAK;QACtB;IACD;IAEA,OAAO;AACR;AAKO,eAAe,kBAAkB,MAAc;IACrD,oBAAoB;IACpB,MAAM,SAAS,YAAY,GAAG,CAAC,CAAC,OAAO,EAAE,QAAQ;IACjD,IAAI,UAAU,OAAO,MAAM,GAAG,KAAK,GAAG,IAAI;QACzC,OAAO,OAAO,MAAM;IACrB;IAEA,MAAM,eAAe,MAAM,6IAAE,CAAC,YAAY,CAAC,SAAS,CAAC;QACpD,OAAO;YACN;YACA,aAAa;QACd;QACA,SAAS;YACR,QAAQ;QACT;IACD;IAEA,IAAI,cAAc,UAAU,aAAa,MAAM,CAAC,QAAQ,EAAE;QACzD,YAAY,GAAG,CAAC,CAAC,OAAO,EAAE,QAAQ,EAAE;YACnC,QAAQ,aAAa,MAAM;YAC3B,QAAQ,KAAK,GAAG,KAAK;QACtB;QACA,OAAO,aAAa,MAAM;IAC3B;IAEA,OAAO;AACR;AAKO,eAAe,qBACrB,QAAuB;IAEvB,IAAI,CAAC,UAAU,OAAO;IAEtB,yBAAyB;IACzB,MAAM,OAAO,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE;IACnC,IAAI,CAAC,MAAM,OAAO;IAElB,yCAAyC;IACzC,MAAM,kBAAkB;QAAC;QAAgB;QAAa;KAAY;IAClE,MAAM,eAAe,gBAAgB,IAAI,CACxC,CAAC,IAAM,SAAS,KAAK,SAAS,CAAC,IAAI,EAAE,GAAG;IAGzC,IAAI,cAAc;QACjB,4BAA4B;QAC5B,OAAO;IACR;IAEA,iDAAiD;IACjD,MAAM,iBAAiB,KAAK,KAAK,CAAC;IAClC,IAAI,gBAAgB,CAAC,EAAE,EAAE;QACxB,MAAM,OAAO,cAAc,CAAC,EAAE;QAC9B,yBAAyB;QACzB,IAAI;YAAC;YAAO;YAAO;YAAS;YAAW;SAAM,CAAC,QAAQ,CAAC,OAAO;YAC7D,OAAO;QACR;QACA,OAAO,gBAAgB;IACxB;IAEA,wDAAwD;IACxD,MAAM,sBAAsB,KAAK,KAAK,CAAC;IACvC,IAAI,qBAAqB,CAAC,EAAE,EAAE;QAC7B,OAAO,gBAAgB,mBAAmB,CAAC,EAAE;IAC9C;IAEA,2CAA2C;IAC3C,OAAO,kBAAkB;AAC1B;AAKO,SAAS,iBAAiB,UAAmB;IACnD,IAAI,YAAY;QACf,YAAY,MAAM,CAAC,CAAC,KAAK,EAAE,YAAY;QACvC,YAAY,MAAM,CAAC,CAAC,OAAO,EAAE,YAAY;IAC1C,OAAO;QACN,YAAY,KAAK;IAClB;AACD"}},
    {"offset": {"line": 125, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/tenant.ts"],"sourcesContent":["\"use server\";\n\nimport { headers } from \"next/headers\";\nimport { cache } from \"react\";\nimport { getTenantByDomain, getTenantBySlug } from \"@/lib/tenant\";\nimport type { Tenant } from \"@boostcart/database\";\nimport { auth } from \"./auth\";\nimport { db } from \"./db\";\n\n/**\n * Get the current tenant from the request context (storefront)\n * This is cached per-request using React's cache()\n */\nexport const getCurrentTenant = cache(async (): Promise<Tenant | null> => {\n\tconst headersList = await headers();\n\n\t// Check for tenant slug from subdomain\n\tconst tenantSlug = headersList.get(\"x-tenant-slug\");\n\tif (tenantSlug) {\n\t\treturn getTenantBySlug(tenantSlug);\n\t}\n\n\t// Check for custom domain\n\tconst customDomain = headersList.get(\"x-custom-domain\");\n\tif (customDomain) {\n\t\treturn getTenantByDomain(customDomain);\n\t}\n\n\treturn null;\n});\n\n/**\n * Get the current tenant for admin context (from user's store ownership)\n * This is used when accessing via boostcart.bg/admin (not subdomain)\n */\nexport const getAdminTenant = cache(async (): Promise<Tenant | null> => {\n\tconst session = await auth();\n\tif (!session?.user?.id) {\n\t\treturn null;\n\t}\n\n\t// Get the user's primary store (first store they have access to)\n\tconst staffRecord = await db.tenantStaff.findFirst({\n\t\twhere: { userId: session.user.id },\n\t\tinclude: { tenant: true },\n\t\torderBy: { createdAt: \"asc\" },\n\t});\n\n\treturn staffRecord?.tenant ?? null;\n});\n\n/**\n * Require tenant to be present (storefront context), throws if not found\n */\nexport async function requireTenant(): Promise<Tenant> {\n\tconst tenant = await getCurrentTenant();\n\tif (!tenant) {\n\t\tthrow new Error(\"Tenant not found\");\n\t}\n\treturn tenant;\n}\n\n/**\n * Require tenant for admin operations\n * First checks storefront context, then falls back to user's store\n */\nexport async function requireAdminTenant(): Promise<Tenant> {\n\t// First try storefront context (subdomain access)\n\tconst storefrontTenant = await getCurrentTenant();\n\tif (storefrontTenant) {\n\t\treturn storefrontTenant;\n\t}\n\n\t// Fall back to user's store (main domain admin access)\n\tconst adminTenant = await getAdminTenant();\n\tif (adminTenant) {\n\t\treturn adminTenant;\n\t}\n\n\tthrow new Error(\"No tenant context found. Please create or select a store.\");\n}\n\n/**\n * Check if we're in a tenant context\n */\nexport async function hasTenantContext(): Promise<boolean> {\n\tconst tenant = await getCurrentTenant();\n\treturn tenant !== null;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AAEA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;AAMO,MAAM,mBAAmB,IAAA,8MAAK,EAAC;IACrC,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,uCAAuC;IACvC,MAAM,aAAa,YAAY,GAAG,CAAC;IACnC,IAAI,YAAY;QACf,OAAO,IAAA,2JAAe,EAAC;IACxB;IAEA,0BAA0B;IAC1B,MAAM,eAAe,YAAY,GAAG,CAAC;IACrC,IAAI,cAAc;QACjB,OAAO,IAAA,6JAAiB,EAAC;IAC1B;IAEA,OAAO;AACR;AAMO,MAAM,iBAAiB,IAAA,8MAAK,EAAC;IACnC,MAAM,UAAU,MAAM,IAAA,0KAAI;IAC1B,IAAI,CAAC,SAAS,MAAM,IAAI;QACvB,OAAO;IACR;IAEA,iEAAiE;IACjE,MAAM,cAAc,MAAM,6IAAE,CAAC,WAAW,CAAC,SAAS,CAAC;QAClD,OAAO;YAAE,QAAQ,QAAQ,IAAI,CAAC,EAAE;QAAC;QACjC,SAAS;YAAE,QAAQ;QAAK;QACxB,SAAS;YAAE,WAAW;QAAM;IAC7B;IAEA,OAAO,aAAa,UAAU;AAC/B;AAKO,eAAe;IACrB,MAAM,SAAS,MAAM;IACrB,IAAI,CAAC,QAAQ;QACZ,MAAM,IAAI,MAAM;IACjB;IACA,OAAO;AACR;AAMO,eAAe;IACrB,kDAAkD;IAClD,MAAM,mBAAmB,MAAM;IAC/B,IAAI,kBAAkB;QACrB,OAAO;IACR;IAEA,uDAAuD;IACvD,MAAM,cAAc,MAAM;IAC1B,IAAI,aAAa;QAChB,OAAO;IACR;IAEA,MAAM,IAAI,MAAM;AACjB;AAKO,eAAe;IACrB,MAAM,SAAS,MAAM;IACrB,OAAO,WAAW;AACnB;;;IAlCsB;IAYA;IAmBA;;;;AA/BA,+OAAA;AAYA,+OAAA;AAmBA,+OAAA"}},
    {"offset": {"line": 255, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/packages/storage/src/utils.ts"],"sourcesContent":["import { randomUUID } from \"crypto\";\n\n/**\n * File type categories\n */\nexport type FileType = \"image\" | \"video\" | \"document\" | \"other\";\n\n/**\n * Common MIME types mapping\n */\nconst MIME_TYPES: Record<string, string> = {\n  // Images\n  jpg: \"image/jpeg\",\n  jpeg: \"image/jpeg\",\n  png: \"image/png\",\n  gif: \"image/gif\",\n  webp: \"image/webp\",\n  svg: \"image/svg+xml\",\n  avif: \"image/avif\",\n  // Videos\n  mp4: \"video/mp4\",\n  webm: \"video/webm\",\n  mov: \"video/quicktime\",\n  avi: \"video/x-msvideo\",\n  // Documents\n  pdf: \"application/pdf\",\n  doc: \"application/msword\",\n  docx: \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  xls: \"application/vnd.ms-excel\",\n  xlsx: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  csv: \"text/csv\",\n  txt: \"text/plain\",\n  json: \"application/json\",\n};\n\n/**\n * Generate a unique upload key for R2\n * Format: {tenantId}/{folder}/{uuid}.{ext}\n */\nexport function generateUploadKey(\n  tenantId: string,\n  originalFilename: string,\n  folder?: string | null\n): string {\n  const ext = getFileExtension(originalFilename);\n  const uuid = randomUUID();\n  const filename = `${uuid}${ext ? `.${ext}` : \"\"}`;\n\n  if (folder) {\n    return `${tenantId}/${folder}/${filename}`;\n  }\n  return `${tenantId}/${filename}`;\n}\n\n/**\n * Get file extension from filename\n */\nexport function getFileExtension(filename: string): string {\n  const parts = filename.split(\".\");\n  if (parts.length < 2) return \"\";\n  return parts.pop()?.toLowerCase() ?? \"\";\n}\n\n/**\n * Get MIME type from filename\n */\nexport function getMimeType(filename: string): string {\n  const ext = getFileExtension(filename);\n  return MIME_TYPES[ext] ?? \"application/octet-stream\";\n}\n\n/**\n * Check if file is an image\n */\nexport function isImageFile(mimeType: string): boolean {\n  return mimeType.startsWith(\"image/\");\n}\n\n/**\n * Check if file is a video\n */\nexport function isVideoFile(mimeType: string): boolean {\n  return mimeType.startsWith(\"video/\");\n}\n\n/**\n * Check if file is a document\n */\nexport function isDocumentFile(mimeType: string): boolean {\n  return (\n    mimeType.includes(\"pdf\") ||\n    mimeType.includes(\"document\") ||\n    mimeType.includes(\"spreadsheet\") ||\n    mimeType.includes(\"text/\")\n  );\n}\n\n/**\n * Get file type category\n */\nexport function getFileType(mimeType: string): FileType {\n  if (isImageFile(mimeType)) return \"image\";\n  if (isVideoFile(mimeType)) return \"video\";\n  if (isDocumentFile(mimeType)) return \"document\";\n  return \"other\";\n}\n\n/**\n * Format file size for display\n */\nexport function formatFileSize(bytes: number): string {\n  if (bytes === 0) return \"0 B\";\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;\n}\n\n/**\n * Validate file size\n */\nexport function validateFileSize(\n  bytes: number,\n  maxSizeMB: number = 10\n): boolean {\n  return bytes <= maxSizeMB * 1024 * 1024;\n}\n\n/**\n * Allowed file types for upload\n */\nexport const ALLOWED_IMAGE_TYPES = [\n  \"image/jpeg\",\n  \"image/png\",\n  \"image/gif\",\n  \"image/webp\",\n  \"image/svg+xml\",\n  \"image/avif\",\n];\n\nexport const ALLOWED_VIDEO_TYPES = [\n  \"video/mp4\",\n  \"video/webm\",\n  \"video/quicktime\",\n];\n\nexport const ALLOWED_DOCUMENT_TYPES = [\n  \"application/pdf\",\n  \"application/msword\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"text/csv\",\n  \"text/plain\",\n];\n\nexport const ALLOWED_FILE_TYPES = [\n  ...ALLOWED_IMAGE_TYPES,\n  ...ALLOWED_VIDEO_TYPES,\n  ...ALLOWED_DOCUMENT_TYPES,\n];\n\n/**\n * Validate file type\n */\nexport function validateFileType(\n  mimeType: string,\n  allowedTypes: string[] = ALLOWED_FILE_TYPES\n): boolean {\n  return allowedTypes.includes(mimeType);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAOA;;CAEC,GACD,MAAM,aAAqC;IACzC,SAAS;IACT,KAAK;IACL,MAAM;IACN,KAAK;IACL,KAAK;IACL,MAAM;IACN,KAAK;IACL,MAAM;IACN,SAAS;IACT,KAAK;IACL,MAAM;IACN,KAAK;IACL,KAAK;IACL,YAAY;IACZ,KAAK;IACL,KAAK;IACL,MAAM;IACN,KAAK;IACL,MAAM;IACN,KAAK;IACL,KAAK;IACL,MAAM;AACR;AAMO,SAAS,kBACd,QAAgB,EAChB,gBAAwB,EACxB,MAAsB;IAEtB,MAAM,MAAM,iBAAiB;IAC7B,MAAM,OAAO,IAAA,mHAAU;IACvB,MAAM,WAAW,GAAG,OAAO,MAAM,CAAC,CAAC,EAAE,KAAK,GAAG,IAAI;IAEjD,IAAI,QAAQ;QACV,OAAO,GAAG,SAAS,CAAC,EAAE,OAAO,CAAC,EAAE,UAAU;IAC5C;IACA,OAAO,GAAG,SAAS,CAAC,EAAE,UAAU;AAClC;AAKO,SAAS,iBAAiB,QAAgB;IAC/C,MAAM,QAAQ,SAAS,KAAK,CAAC;IAC7B,IAAI,MAAM,MAAM,GAAG,GAAG,OAAO;IAC7B,OAAO,MAAM,GAAG,IAAI,iBAAiB;AACvC;AAKO,SAAS,YAAY,QAAgB;IAC1C,MAAM,MAAM,iBAAiB;IAC7B,OAAO,UAAU,CAAC,IAAI,IAAI;AAC5B;AAKO,SAAS,YAAY,QAAgB;IAC1C,OAAO,SAAS,UAAU,CAAC;AAC7B;AAKO,SAAS,YAAY,QAAgB;IAC1C,OAAO,SAAS,UAAU,CAAC;AAC7B;AAKO,SAAS,eAAe,QAAgB;IAC7C,OACE,SAAS,QAAQ,CAAC,UAClB,SAAS,QAAQ,CAAC,eAClB,SAAS,QAAQ,CAAC,kBAClB,SAAS,QAAQ,CAAC;AAEtB;AAKO,SAAS,YAAY,QAAgB;IAC1C,IAAI,YAAY,WAAW,OAAO;IAClC,IAAI,YAAY,WAAW,OAAO;IAClC,IAAI,eAAe,WAAW,OAAO;IACrC,OAAO;AACT;AAKO,SAAS,eAAe,KAAa;IAC1C,IAAI,UAAU,GAAG,OAAO;IACxB,MAAM,IAAI;IACV,MAAM,QAAQ;QAAC;QAAK;QAAM;QAAM;KAAK;IACrC,MAAM,IAAI,KAAK,KAAK,CAAC,KAAK,GAAG,CAAC,SAAS,KAAK,GAAG,CAAC;IAChD,OAAO,GAAG,WAAW,CAAC,QAAQ,KAAK,GAAG,CAAC,GAAG,EAAE,EAAE,OAAO,CAAC,IAAI,CAAC,EAAE,KAAK,CAAC,EAAE,EAAE;AACzE;AAKO,SAAS,iBACd,KAAa,EACb,YAAoB,EAAE;IAEtB,OAAO,SAAS,YAAY,OAAO;AACrC;AAKO,MAAM,sBAAsB;IACjC;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,sBAAsB;IACjC;IACA;IACA;CACD;AAEM,MAAM,yBAAyB;IACpC;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,qBAAqB;OAC7B;OACA;OACA;CACJ;AAKM,SAAS,iBACd,QAAgB,EAChB,eAAyB,kBAAkB;IAE3C,OAAO,aAAa,QAAQ,CAAC;AAC/B"}},
    {"offset": {"line": 395, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/packages/storage/src/r2.ts"],"sourcesContent":["import {\n  S3Client,\n  PutObjectCommand,\n  DeleteObjectCommand,\n  GetObjectCommand,\n  HeadObjectCommand,\n  ListObjectsV2Command,\n  type PutObjectCommandInput,\n} from \"@aws-sdk/client-s3\";\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\nimport { generateUploadKey, getMimeType } from \"./utils\";\n\nexport interface R2Config {\n  accountId: string;\n  accessKeyId: string;\n  secretAccessKey: string;\n  bucketName: string;\n  endpoint?: string; // Optional: full endpoint URL for regional buckets\n  publicUrl?: string; // Custom domain or R2 public URL\n}\n\nexport interface UploadOptions {\n  tenantId: string;\n  filename: string;\n  contentType?: string;\n  folder?: string | null;\n  metadata?: Record<string, string>;\n}\n\nexport interface UploadResult {\n  key: string;\n  url: string;\n  filename: string;\n  size: number;\n  contentType: string;\n}\n\nexport interface PresignedUploadResult {\n  uploadUrl: string;\n  key: string;\n  publicUrl: string;\n}\n\n/**\n * Cloudflare R2 Storage Client\n * Uses S3-compatible API\n */\nexport class R2Client {\n  private client: S3Client;\n  private bucketName: string;\n  private publicUrl: string;\n\n  constructor(config: R2Config) {\n    // Support custom endpoint (for regional buckets) or construct default\n    const endpoint =\n      config.endpoint ?? `https://${config.accountId}.r2.cloudflarestorage.com`;\n\n    this.client = new S3Client({\n      region: \"auto\",\n      endpoint,\n      credentials: {\n        accessKeyId: config.accessKeyId,\n        secretAccessKey: config.secretAccessKey,\n      },\n    });\n    this.bucketName = config.bucketName;\n    // Use custom domain or construct R2 public URL\n    this.publicUrl =\n      config.publicUrl ??\n      `https://${config.bucketName}.${config.accountId}.r2.cloudflarestorage.com`;\n  }\n\n  /**\n   * Upload a file directly to R2\n   */\n  async upload(\n    file: Buffer | Uint8Array | ReadableStream,\n    options: UploadOptions\n  ): Promise<UploadResult> {\n    const key = generateUploadKey(\n      options.tenantId,\n      options.filename,\n      options.folder\n    );\n    const contentType = options.contentType ?? getMimeType(options.filename);\n\n    const params: PutObjectCommandInput = {\n      Bucket: this.bucketName,\n      Key: key,\n      Body: file,\n      ContentType: contentType,\n      Metadata: {\n        ...options.metadata,\n        tenantId: options.tenantId,\n        originalFilename: options.filename,\n      },\n    };\n\n    await this.client.send(new PutObjectCommand(params));\n\n    // Get file size\n    const headResponse = await this.client.send(\n      new HeadObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      })\n    );\n\n    return {\n      key,\n      url: this.getPublicUrl(key),\n      filename: options.filename,\n      size: headResponse.ContentLength ?? 0,\n      contentType,\n    };\n  }\n\n  /**\n   * Generate a presigned URL for client-side uploads\n   * This allows direct upload to R2 without going through the server\n   */\n  async getPresignedUploadUrl(\n    options: UploadOptions,\n    expiresIn: number = 3600 // 1 hour\n  ): Promise<PresignedUploadResult> {\n    const key = generateUploadKey(\n      options.tenantId,\n      options.filename,\n      options.folder\n    );\n    const contentType = options.contentType ?? getMimeType(options.filename);\n\n    const command = new PutObjectCommand({\n      Bucket: this.bucketName,\n      Key: key,\n      ContentType: contentType,\n      Metadata: {\n        tenantId: options.tenantId,\n        originalFilename: options.filename,\n      },\n    });\n\n    const uploadUrl = await getSignedUrl(this.client, command, { expiresIn });\n\n    return {\n      uploadUrl,\n      key,\n      publicUrl: this.getPublicUrl(key),\n    };\n  }\n\n  /**\n   * Get a presigned URL for downloading/viewing a private file\n   */\n  async getPresignedDownloadUrl(\n    key: string,\n    expiresIn: number = 3600\n  ): Promise<string> {\n    const command = new GetObjectCommand({\n      Bucket: this.bucketName,\n      Key: key,\n    });\n\n    return getSignedUrl(this.client, command, { expiresIn });\n  }\n\n  /**\n   * Delete a file from R2\n   */\n  async delete(key: string): Promise<void> {\n    await this.client.send(\n      new DeleteObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      })\n    );\n  }\n\n  /**\n   * Delete multiple files from R2\n   */\n  async deleteMany(keys: string[]): Promise<void> {\n    await Promise.all(keys.map((key) => this.delete(key)));\n  }\n\n  /**\n   * Check if a file exists\n   */\n  async exists(key: string): Promise<boolean> {\n    try {\n      await this.client.send(\n        new HeadObjectCommand({\n          Bucket: this.bucketName,\n          Key: key,\n        })\n      );\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * List files in a folder\n   */\n  async listFiles(\n    tenantId: string,\n    folder?: string | null,\n    maxKeys: number = 1000\n  ) {\n    const prefix = folder ? `${tenantId}/${folder}/` : `${tenantId}/`;\n\n    const response = await this.client.send(\n      new ListObjectsV2Command({\n        Bucket: this.bucketName,\n        Prefix: prefix,\n        MaxKeys: maxKeys,\n      })\n    );\n\n    return (\n      response.Contents?.map((item) => ({\n        key: item.Key!,\n        size: item.Size ?? 0,\n        lastModified: item.LastModified,\n        url: this.getPublicUrl(item.Key!),\n      })) ?? []\n    );\n  }\n\n  /**\n   * Get public URL for a file\n   */\n  getPublicUrl(key: string): string {\n    return `${this.publicUrl}/${key}`;\n  }\n\n  /**\n   * Extract key from public URL\n   */\n  getKeyFromUrl(url: string): string | null {\n    if (!url.startsWith(this.publicUrl)) return null;\n    return url.slice(this.publicUrl.length + 1);\n  }\n}\n\n/**\n * Create R2 client from environment variables\n */\nexport function createR2Client(config: R2Config): R2Client {\n  return new R2Client(config);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 553, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/packages/storage/src/folders.ts"],"sourcesContent":["/**\n * Flat folder structure for organizing media files.\n * Files are stored with paths like: /{tenantId}/{folder}/{filename}\n */\nexport const FOLDERS = {\n  ROOT: null,\n  PRODUCTS: \"products\",\n  BLOG: \"blog\",\n  PAGES: \"pages\",\n  MARKETING: \"marketing\",\n  AVATARS: \"avatars\",\n  OTHER: \"other\",\n} as const;\n\nexport type FolderType = (typeof FOLDERS)[keyof typeof FOLDERS];\n\n/**\n * Folder metadata for UI display\n */\nexport const FOLDER_META: Record<\n  Exclude<FolderType, null>,\n  { label: string; description: string }\n> = {\n  products: {\n    label: \"Products\",\n    description: \"Product images and galleries\",\n  },\n  blog: {\n    label: \"Blog\",\n    description: \"Blog post images and media\",\n  },\n  pages: {\n    label: \"Pages\",\n    description: \"Static page images\",\n  },\n  marketing: {\n    label: \"Marketing\",\n    description: \"Banners, promotional images\",\n  },\n  avatars: {\n    label: \"Avatars\",\n    description: \"User and customer avatars\",\n  },\n  other: {\n    label: \"Other\",\n    description: \"Miscellaneous files\",\n  },\n};\n\n/**\n * Get folder label for display\n */\nexport function getFolderLabel(folder: FolderType): string {\n  if (folder === null) return \"All Files\";\n  return FOLDER_META[folder]?.label ?? folder;\n}\n\n/**\n * Validate folder name\n */\nexport function isValidFolder(folder: string | null): folder is FolderType {\n  if (folder === null) return true;\n  return Object.values(FOLDERS).includes(folder as FolderType);\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;AACM,MAAM,UAAU;IACrB,MAAM;IACN,UAAU;IACV,MAAM;IACN,OAAO;IACP,WAAW;IACX,SAAS;IACT,OAAO;AACT;AAOO,MAAM,cAGT;IACF,UAAU;QACR,OAAO;QACP,aAAa;IACf;IACA,MAAM;QACJ,OAAO;QACP,aAAa;IACf;IACA,OAAO;QACL,OAAO;QACP,aAAa;IACf;IACA,WAAW;QACT,OAAO;QACP,aAAa;IACf;IACA,SAAS;QACP,OAAO;QACP,aAAa;IACf;IACA,OAAO;QACL,OAAO;QACP,aAAa;IACf;AACF;AAKO,SAAS,eAAe,MAAkB;IAC/C,IAAI,WAAW,MAAM,OAAO;IAC5B,OAAO,WAAW,CAAC,OAAO,EAAE,SAAS;AACvC;AAKO,SAAS,cAAc,MAAqB;IACjD,IAAI,WAAW,MAAM,OAAO;IAC5B,OAAO,OAAO,MAAM,CAAC,SAAS,QAAQ,CAAC;AACzC"}},
    {"offset": {"line": 613, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/packages/storage/src/index.ts"],"sourcesContent":["export { R2Client, type R2Config, type UploadOptions, type UploadResult } from \"./r2\";\nexport {\n  generateUploadKey,\n  getFileExtension,\n  getMimeType,\n  isImageFile,\n  isVideoFile,\n  isDocumentFile,\n  getFileType,\n  formatFileSize,\n  validateFileSize,\n  validateFileType,\n  ALLOWED_FILE_TYPES,\n  ALLOWED_IMAGE_TYPES,\n  ALLOWED_VIDEO_TYPES,\n  ALLOWED_DOCUMENT_TYPES,\n  type FileType,\n} from \"./utils\";\nexport { FOLDERS, type FolderType } from \"./folders\";\n"],"names":[],"mappings":";AAAA;AACA;AAiBA"}},
    {"offset": {"line": 624, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/storage.ts"],"sourcesContent":["import { R2Client } from \"@boostcart/storage\";\nimport { env } from \"@/env\";\n\n/**\n * R2 Storage Client Singleton\n * Used for file uploads throughout the platform\n */\nfunction createStorageClient() {\n  return new R2Client({\n    accountId: env.R2_ACCOUNT_ID,\n    accessKeyId: env.R2_ACCESS_KEY_ID,\n    secretAccessKey: env.R2_SECRET_ACCESS_KEY,\n    bucketName: env.R2_BUCKET_NAME,\n    endpoint: env.R2_ENDPOINT, // Optional: for regional buckets\n    publicUrl: env.R2_CUSTOM_DOMAIN, // Custom domain for public URLs\n  });\n}\n\n// Global singleton for storage client\nconst globalForStorage = globalThis as unknown as {\n  storage: R2Client | undefined;\n};\n\nexport const storage = globalForStorage.storage ?? createStorageClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForStorage.storage = storage;\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEA;;;CAGC,GACD,SAAS;IACP,OAAO,IAAI,4IAAQ,CAAC;QAClB,WAAW,qIAAG,CAAC,aAAa;QAC5B,aAAa,qIAAG,CAAC,gBAAgB;QACjC,iBAAiB,qIAAG,CAAC,oBAAoB;QACzC,YAAY,qIAAG,CAAC,cAAc;QAC9B,UAAU,qIAAG,CAAC,WAAW;QACzB,WAAW,qIAAG,CAAC,gBAAgB;IACjC;AACF;AAEA,sCAAsC;AACtC,MAAM,mBAAmB;AAIlB,MAAM,UAAU,iBAAiB,OAAO,IAAI;AAEnD,wCAA2C;IACzC,iBAAiB,OAAO,GAAG;AAC7B"}},
    {"offset": {"line": 658, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/services/media-cleanup.ts"],"sourcesContent":["import { db } from \"@/server/db\";\nimport { storage } from \"@/server/storage\";\nimport { env } from \"@/env\";\n\n/**\n * Extract image URLs from HTML content that belong to our R2 bucket\n */\nexport function extractR2ImageUrls(htmlContent: string): string[] {\n\tif (!htmlContent) return [];\n\n\tconst publicUrl = env.R2_CUSTOM_DOMAIN;\n\tif (!publicUrl) return [];\n\n\t// Match img src attributes that point to our R2 bucket\n\tconst imgRegex = /<img[^>]+src=[\"']([^\"']+)[\"'][^>]*>/gi;\n\tconst urls: string[] = [];\n\tlet match: RegExpExecArray | null;\n\n\twhile (true) {\n\t\tmatch = imgRegex.exec(htmlContent);\n\t\tif (!match) break;\n\t\tconst url = match[1];\n\t\tif (url?.startsWith(publicUrl)) {\n\t\t\turls.push(url);\n\t\t}\n\t}\n\n\treturn urls;\n}\n\n/**\n * Convert public URL to R2 key\n */\nexport function urlToR2Key(url: string): string | null {\n\tconst publicUrl = env.R2_CUSTOM_DOMAIN;\n\tif (!publicUrl || !url.startsWith(publicUrl)) return null;\n\n\t// Remove the public URL prefix to get the key\n\treturn url.slice(publicUrl.length + 1); // +1 for the trailing slash\n}\n\n/**\n * Check if an image URL is used in any blog post content\n */\nasync function isImageUsedInBlogPosts(\n\turl: string,\n\ttenantId: string,\n\texcludePostId?: string\n): Promise<boolean> {\n\tconst posts = await db.blogPostTranslation.findMany({\n\t\twhere: {\n\t\t\tpost: { tenantId },\n\t\t\t...(excludePostId && { postId: { not: excludePostId } }),\n\t\t\tcontent: { contains: url },\n\t\t},\n\t\tselect: { id: true },\n\t\ttake: 1,\n\t});\n\n\treturn posts.length > 0;\n}\n\n/**\n * Check if an image URL is used in any page content\n */\nasync function isImageUsedInPages(\n\turl: string,\n\ttenantId: string,\n\texcludePageId?: string\n): Promise<boolean> {\n\tconst pages = await db.pageTranslation.findMany({\n\t\twhere: {\n\t\t\tpage: { tenantId },\n\t\t\t...(excludePageId && { pageId: { not: excludePageId } }),\n\t\t\tcontent: { contains: url },\n\t\t},\n\t\tselect: { id: true },\n\t\ttake: 1,\n\t});\n\n\treturn pages.length > 0;\n}\n\n/**\n * Check if an image URL is used in product media\n */\nasync function isImageUsedInProducts(\n\turl: string,\n\ttenantId: string\n): Promise<boolean> {\n\tconst media = await db.productMedia.findFirst({\n\t\twhere: {\n\t\t\tproduct: { tenantId },\n\t\t\turl,\n\t\t},\n\t\tselect: { id: true },\n\t});\n\n\treturn !!media;\n}\n\n/**\n * Check if an image is used anywhere in the tenant's content\n */\nexport async function isImageUsedElsewhere(\n\turl: string,\n\ttenantId: string,\n\tcontext: {\n\t\texcludeBlogPostId?: string;\n\t\texcludePageId?: string;\n\t} = {}\n): Promise<boolean> {\n\tconst [inBlogPosts, inPages, inProducts] = await Promise.all([\n\t\tisImageUsedInBlogPosts(url, tenantId, context.excludeBlogPostId),\n\t\tisImageUsedInPages(url, tenantId, context.excludePageId),\n\t\tisImageUsedInProducts(url, tenantId),\n\t]);\n\n\treturn inBlogPosts || inPages || inProducts;\n}\n\n/**\n * Delete images from R2 that are not used elsewhere\n * Returns the number of images deleted\n */\nexport async function cleanupUnusedImages(\n\timageUrls: string[],\n\ttenantId: string,\n\tcontext: {\n\t\texcludeBlogPostId?: string;\n\t\texcludePageId?: string;\n\t} = {}\n): Promise<number> {\n\tlet deletedCount = 0;\n\n\tfor (const url of imageUrls) {\n\t\tconst isUsed = await isImageUsedElsewhere(url, tenantId, context);\n\n\t\tif (!isUsed) {\n\t\t\tconst key = urlToR2Key(url);\n\t\t\tif (key) {\n\t\t\t\ttry {\n\t\t\t\t\tawait storage.delete(key);\n\t\t\t\t\tdeletedCount++;\n\t\t\t\t\tconsole.log(`[Media Cleanup] Deleted unused image: ${key}`);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(`[Media Cleanup] Failed to delete image: ${key}`, error);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn deletedCount;\n}\n\n/**\n * Cleanup images from blog post content\n */\nexport async function cleanupBlogPostImages(\n\tcontent: string,\n\ttenantId: string,\n\tblogPostId: string\n): Promise<number> {\n\tconst imageUrls = extractR2ImageUrls(content);\n\tif (imageUrls.length === 0) return 0;\n\n\treturn cleanupUnusedImages(imageUrls, tenantId, {\n\t\texcludeBlogPostId: blogPostId,\n\t});\n}\n\n/**\n * Cleanup images from page content\n */\nexport async function cleanupPageImages(\n\tcontent: string,\n\ttenantId: string,\n\tpageId: string\n): Promise<number> {\n\tconst imageUrls = extractR2ImageUrls(content);\n\tif (imageUrls.length === 0) return 0;\n\n\treturn cleanupUnusedImages(imageUrls, tenantId, {\n\t\texcludePageId: pageId,\n\t});\n}\n\n/**\n * Cleanup product media files\n */\nexport async function cleanupProductMedia(\n\tmediaUrls: string[],\n\ttenantId: string\n): Promise<number> {\n\tlet deletedCount = 0;\n\n\tfor (const url of mediaUrls) {\n\t\t// Check if the URL is from our R2 bucket\n\t\tconst key = urlToR2Key(url);\n\t\tif (!key) continue;\n\n\t\t// Check if this media is used in other products or content\n\t\tconst isUsed = await isImageUsedElsewhere(url, tenantId);\n\n\t\tif (!isUsed) {\n\t\t\ttry {\n\t\t\t\tawait storage.delete(key);\n\t\t\t\tdeletedCount++;\n\t\t\t\tconsole.log(`[Media Cleanup] Deleted product media: ${key}`);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(`[Media Cleanup] Failed to delete media: ${key}`, error);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn deletedCount;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 840, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/internal/blog.ts"],"sourcesContent":["\"use server\";\n\nimport { auth } from \"@/server/auth\";\nimport { db } from \"@/server/db\";\nimport { requireAdminTenant } from \"@/server/tenant\";\nimport { cleanupBlogPostImages } from \"@/server/services/media-cleanup\";\n\nasync function requireStoreAccess() {\n\tconst session = await auth();\n\tif (!session?.user?.id) {\n\t\tthrow new Error(\"Unauthorized\");\n\t}\n\n\tconst tenant = await requireAdminTenant();\n\n\tconst staffRecord = await db.tenantStaff.findFirst({\n\t\twhere: {\n\t\t\tuserId: session.user.id,\n\t\t\ttenantId: tenant.id,\n\t\t},\n\t});\n\n\tif (!staffRecord) {\n\t\tthrow new Error(\"Forbidden: No access to this store\");\n\t}\n\n\treturn {\n\t\tuserId: session.user.id,\n\t\ttenantId: tenant.id,\n\t\trole: staffRecord.role,\n\t};\n}\n\nexport async function getBlogPosts() {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst posts = await db.blogPost.findMany({\n\t\twhere: { tenantId },\n\t\tinclude: {\n\t\t\ttranslations: {\n\t\t\t\tinclude: {\n\t\t\t\t\tlocale: true,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\torderBy: { createdAt: \"desc\" },\n\t});\n\n\treturn posts.map((post) => ({\n\t\tid: post.id,\n\t\tslug: post.slug,\n\t\tfeaturedImage: post.featuredImage,\n\t\tauthor: post.author,\n\t\tisPublished: post.isPublished,\n\t\tpublishedAt: post.publishedAt,\n\t\ttitle: post.translations[0]?.title ?? post.slug,\n\t\texcerpt: post.translations[0]?.excerpt ?? \"\",\n\t\tcontent: post.translations[0]?.content ?? \"\",\n\t\ttranslations: post.translations.map((t) => ({\n\t\t\tlocaleId: t.localeId,\n\t\t\tlocaleCode: t.locale.code,\n\t\t\tlocaleName: t.locale.name,\n\t\t\ttitle: t.title,\n\t\t\texcerpt: t.excerpt,\n\t\t\tcontent: t.content,\n\t\t})),\n\t\tcreatedAt: post.createdAt,\n\t\tupdatedAt: post.updatedAt,\n\t}));\n}\n\nexport async function getBlogPost(id: string) {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst post = await db.blogPost.findFirst({\n\t\twhere: { id, tenantId },\n\t\tinclude: {\n\t\t\ttranslations: {\n\t\t\t\tinclude: {\n\t\t\t\t\tlocale: true,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t});\n\n\tif (!post) {\n\t\tthrow new Error(\"Blog post not found\");\n\t}\n\n\treturn {\n\t\tid: post.id,\n\t\tslug: post.slug,\n\t\tfeaturedImage: post.featuredImage,\n\t\tauthor: post.author,\n\t\tisPublished: post.isPublished,\n\t\tpublishedAt: post.publishedAt,\n\t\ttranslations: post.translations.map((t) => ({\n\t\t\tid: t.id,\n\t\t\tlocaleId: t.localeId,\n\t\t\tlocaleCode: t.locale.code,\n\t\t\tlocaleName: t.locale.name,\n\t\t\ttitle: t.title,\n\t\t\texcerpt: t.excerpt,\n\t\t\tcontent: t.content,\n\t\t})),\n\t\tcreatedAt: post.createdAt,\n\t\tupdatedAt: post.updatedAt,\n\t};\n}\n\nexport interface CreateBlogPostInput {\n\tslug: string;\n\tfeaturedImage?: string;\n\tauthor?: string;\n\tisPublished?: boolean;\n\tpublishedAt?: Date;\n\ttranslations: {\n\t\tlocaleId: string;\n\t\ttitle: string;\n\t\texcerpt?: string;\n\t\tcontent: string;\n\t}[];\n}\n\nexport async function createBlogPost(input: CreateBlogPostInput) {\n\tconst { tenantId } = await requireStoreAccess();\n\n\t// Check for duplicate slug\n\tconst existing = await db.blogPost.findUnique({\n\t\twhere: {\n\t\t\ttenantId_slug: {\n\t\t\t\ttenantId,\n\t\t\t\tslug: input.slug,\n\t\t\t},\n\t\t},\n\t});\n\n\tif (existing) {\n\t\tthrow new Error(\"A blog post with this slug already exists\");\n\t}\n\n\tconst post = await db.blogPost.create({\n\t\tdata: {\n\t\t\tslug: input.slug,\n\t\t\tfeaturedImage: input.featuredImage,\n\t\t\tauthor: input.author,\n\t\t\tisPublished: input.isPublished ?? false,\n\t\t\tpublishedAt: input.isPublished ? (input.publishedAt ?? new Date()) : null,\n\t\t\ttenantId,\n\t\t\ttranslations: {\n\t\t\t\tcreate: input.translations.map((t) => ({\n\t\t\t\t\tlocaleId: t.localeId,\n\t\t\t\t\ttitle: t.title,\n\t\t\t\t\texcerpt: t.excerpt,\n\t\t\t\t\tcontent: t.content,\n\t\t\t\t})),\n\t\t\t},\n\t\t},\n\t\tinclude: {\n\t\t\ttranslations: true,\n\t\t},\n\t});\n\n\treturn post;\n}\n\nexport interface UpdateBlogPostInput {\n\tslug?: string;\n\tfeaturedImage?: string | null;\n\tauthor?: string;\n\tisPublished?: boolean;\n\tpublishedAt?: Date | null;\n\ttranslations?: {\n\t\tlocaleId: string;\n\t\ttitle: string;\n\t\texcerpt?: string;\n\t\tcontent: string;\n\t}[];\n}\n\nexport async function updateBlogPost(id: string, input: UpdateBlogPostInput) {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst post = await db.blogPost.findFirst({\n\t\twhere: { id, tenantId },\n\t});\n\n\tif (!post) {\n\t\tthrow new Error(\"Blog post not found or access denied\");\n\t}\n\n\t// Check for duplicate slug if changing\n\tif (input.slug && input.slug !== post.slug) {\n\t\tconst existing = await db.blogPost.findUnique({\n\t\t\twhere: {\n\t\t\t\ttenantId_slug: {\n\t\t\t\t\ttenantId,\n\t\t\t\t\tslug: input.slug,\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\n\t\tif (existing) {\n\t\t\tthrow new Error(\"A blog post with this slug already exists\");\n\t\t}\n\t}\n\n\t// Handle publish state change\n\tlet publishedAt = input.publishedAt;\n\tif (input.isPublished !== undefined) {\n\t\tif (input.isPublished && !post.isPublished) {\n\t\t\t// Publishing for the first time\n\t\t\tpublishedAt = publishedAt ?? new Date();\n\t\t} else if (!input.isPublished) {\n\t\t\t// Unpublishing\n\t\t\tpublishedAt = null;\n\t\t}\n\t}\n\n\tconst updated = await db.blogPost.update({\n\t\twhere: { id },\n\t\tdata: {\n\t\t\tslug: input.slug,\n\t\t\tfeaturedImage: input.featuredImage,\n\t\t\tauthor: input.author,\n\t\t\tisPublished: input.isPublished,\n\t\t\tpublishedAt,\n\t\t\t...(input.translations && {\n\t\t\t\ttranslations: {\n\t\t\t\t\tdeleteMany: {},\n\t\t\t\t\tcreate: input.translations.map((t) => ({\n\t\t\t\t\t\tlocaleId: t.localeId,\n\t\t\t\t\t\ttitle: t.title,\n\t\t\t\t\t\texcerpt: t.excerpt,\n\t\t\t\t\t\tcontent: t.content,\n\t\t\t\t\t})),\n\t\t\t\t},\n\t\t\t}),\n\t\t},\n\t\tinclude: {\n\t\t\ttranslations: true,\n\t\t},\n\t});\n\n\treturn updated;\n}\n\nexport async function deleteBlogPost(id: string) {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst post = await db.blogPost.findFirst({\n\t\twhere: { id, tenantId },\n\t\tinclude: {\n\t\t\ttranslations: {\n\t\t\t\tselect: { content: true },\n\t\t\t},\n\t\t},\n\t});\n\n\tif (!post) {\n\t\tthrow new Error(\"Blog post not found or access denied\");\n\t}\n\n\t// Collect all content from translations to find embedded images\n\tconst allContent = post.translations.map((t) => t.content).join(\"\");\n\n\t// Delete the blog post first\n\tawait db.blogPost.delete({\n\t\twhere: { id },\n\t});\n\n\t// Cleanup images that are no longer used (after deletion)\n\tif (allContent) {\n\t\tawait cleanupBlogPostImages(allContent, tenantId, id);\n\t}\n\n\treturn { success: true };\n}\n\nexport async function toggleBlogPostPublished(id: string) {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst post = await db.blogPost.findFirst({\n\t\twhere: { id, tenantId },\n\t});\n\n\tif (!post) {\n\t\tthrow new Error(\"Blog post not found or access denied\");\n\t}\n\n\tconst isPublished = !post.isPublished;\n\tconst publishedAt = isPublished\n\t\t? post.publishedAt ?? new Date()\n\t\t: post.publishedAt;\n\n\tconst updated = await db.blogPost.update({\n\t\twhere: { id },\n\t\tdata: {\n\t\t\tisPublished,\n\t\t\tpublishedAt,\n\t\t},\n\t});\n\n\treturn updated;\n}\n\nexport async function getBlogStats() {\n\tconst { tenantId } = await requireStoreAccess();\n\n\tconst [total, published, drafts] = await Promise.all([\n\t\tdb.blogPost.count({ where: { tenantId } }),\n\t\tdb.blogPost.count({ where: { tenantId, isPublished: true } }),\n\t\tdb.blogPost.count({ where: { tenantId, isPublished: false } }),\n\t]);\n\n\t// Get recent posts (last 7 days)\n\tconst weekAgo = new Date();\n\tweekAgo.setDate(weekAgo.getDate() - 7);\n\n\tconst recent = await db.blogPost.count({\n\t\twhere: {\n\t\t\ttenantId,\n\t\t\tcreatedAt: { gte: weekAgo },\n\t\t},\n\t});\n\n\treturn {\n\t\ttotal,\n\t\tpublished,\n\t\tdrafts,\n\t\trecent,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1194, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/internal/locales.ts"],"sourcesContent":["\"use server\";\n\nimport { auth } from \"@/server/auth\";\nimport { db } from \"@/server/db\";\nimport { requireAdminTenant } from \"@/server/tenant\";\n\nasync function requireStoreAccess() {\n\tconst session = await auth();\n\tif (!session?.user?.id) {\n\t\tthrow new Error(\"Unauthorized\");\n\t}\n\n\tconst tenant = await requireAdminTenant();\n\n\tconst staffRecord = await db.tenantStaff.findFirst({\n\t\twhere: {\n\t\t\tuserId: session.user.id,\n\t\t\ttenantId: tenant.id,\n\t\t},\n\t});\n\n\tif (!staffRecord) {\n\t\tthrow new Error(\"Forbidden: No access to this store\");\n\t}\n\n\treturn {\n\t\tuserId: session.user.id,\n\t\ttenantId: tenant.id,\n\t\trole: staffRecord.role,\n\t};\n}\n\n/**\n * Get or create a default locale for the platform.\n * This ensures there's always a valid locale available for translations.\n */\nexport async function getOrCreateDefaultLocale() {\n\t// First try to get the default locale\n\tlet defaultLocale = await db.locale.findFirst({\n\t\twhere: { isDefault: true },\n\t});\n\n\tif (!defaultLocale) {\n\t\t// Try to get any existing locale\n\t\tdefaultLocale = await db.locale.findFirst();\n\t}\n\n\tif (!defaultLocale) {\n\t\t// Create a default Bulgarian locale since this is a Bulgarian-focused platform\n\t\tdefaultLocale = await db.locale.create({\n\t\t\tdata: {\n\t\t\t\tcode: \"bg-BG\",\n\t\t\t\tname: \"\",\n\t\t\t\tisDefault: true,\n\t\t\t},\n\t\t});\n\t}\n\n\treturn {\n\t\tid: defaultLocale.id,\n\t\tcode: defaultLocale.code,\n\t\tname: defaultLocale.name,\n\t\tisDefault: defaultLocale.isDefault,\n\t};\n}\n\nexport async function getLocales() {\n\tawait requireStoreAccess();\n\n\tconst locales = await db.locale.findMany({\n\t\torderBy: [{ isDefault: \"desc\" }, { name: \"asc\" }],\n\t});\n\n\treturn locales.map((locale) => ({\n\t\tid: locale.id,\n\t\tcode: locale.code,\n\t\tname: locale.name,\n\t\tisDefault: locale.isDefault,\n\t}));\n}\n\nexport async function getLocale(id: string) {\n\tawait requireStoreAccess();\n\n\tconst locale = await db.locale.findUnique({\n\t\twhere: { id },\n\t});\n\n\tif (!locale) {\n\t\tthrow new Error(\"Locale not found\");\n\t}\n\n\treturn {\n\t\tid: locale.id,\n\t\tcode: locale.code,\n\t\tname: locale.name,\n\t\tisDefault: locale.isDefault,\n\t};\n}\n\nexport interface CreateLocaleInput {\n\tcode: string;\n\tname: string;\n\tisDefault?: boolean;\n}\n\nexport async function createLocale(input: CreateLocaleInput) {\n\tawait requireStoreAccess();\n\n\t// Check for duplicate code\n\tconst existing = await db.locale.findUnique({\n\t\twhere: { code: input.code },\n\t});\n\n\tif (existing) {\n\t\tthrow new Error(\"A locale with this code already exists\");\n\t}\n\n\t// If setting as default, unset other defaults\n\tif (input.isDefault) {\n\t\tawait db.locale.updateMany({\n\t\t\twhere: { isDefault: true },\n\t\t\tdata: { isDefault: false },\n\t\t});\n\t}\n\n\tconst locale = await db.locale.create({\n\t\tdata: {\n\t\t\tcode: input.code,\n\t\t\tname: input.name,\n\t\t\tisDefault: input.isDefault ?? false,\n\t\t},\n\t});\n\n\treturn locale;\n}\n\nexport interface UpdateLocaleInput {\n\tcode?: string;\n\tname?: string;\n\tisDefault?: boolean;\n}\n\nexport async function updateLocale(id: string, input: UpdateLocaleInput) {\n\tawait requireStoreAccess();\n\n\tconst locale = await db.locale.findUnique({\n\t\twhere: { id },\n\t});\n\n\tif (!locale) {\n\t\tthrow new Error(\"Locale not found\");\n\t}\n\n\t// Check for duplicate code if changing\n\tif (input.code && input.code !== locale.code) {\n\t\tconst existing = await db.locale.findUnique({\n\t\t\twhere: { code: input.code },\n\t\t});\n\n\t\tif (existing) {\n\t\t\tthrow new Error(\"A locale with this code already exists\");\n\t\t}\n\t}\n\n\t// If setting as default, unset other defaults\n\tif (input.isDefault && !locale.isDefault) {\n\t\tawait db.locale.updateMany({\n\t\t\twhere: { isDefault: true },\n\t\t\tdata: { isDefault: false },\n\t\t});\n\t}\n\n\tconst updated = await db.locale.update({\n\t\twhere: { id },\n\t\tdata: {\n\t\t\tcode: input.code,\n\t\t\tname: input.name,\n\t\t\tisDefault: input.isDefault,\n\t\t},\n\t});\n\n\treturn updated;\n}\n\nexport async function deleteLocale(id: string) {\n\tawait requireStoreAccess();\n\n\tconst locale = await db.locale.findUnique({\n\t\twhere: { id },\n\t});\n\n\tif (!locale) {\n\t\tthrow new Error(\"Locale not found\");\n\t}\n\n\tif (locale.isDefault) {\n\t\tthrow new Error(\"Cannot delete the default locale\");\n\t}\n\n\t// Check if locale is used in any translations\n\tconst usageCount = await Promise.all([\n\t\tdb.productTranslation.count({ where: { localeId: id } }),\n\t\tdb.categoryTranslation.count({ where: { localeId: id } }),\n\t\tdb.brandTranslation.count({ where: { localeId: id } }),\n\t\tdb.pageTranslation.count({ where: { localeId: id } }),\n\t\tdb.collectionTranslation.count({ where: { localeId: id } }),\n\t\tdb.blogPostTranslation.count({ where: { localeId: id } }),\n\t]);\n\n\tconst totalUsage = usageCount.reduce((sum, count) => sum + count, 0);\n\n\tif (totalUsage > 0) {\n\t\tthrow new Error(\n\t\t\t`Cannot delete locale: it is used in ${totalUsage} translation(s)`\n\t\t);\n\t}\n\n\tawait db.locale.delete({\n\t\twhere: { id },\n\t});\n\n\treturn { success: true };\n}\n\nexport async function setDefaultLocale(id: string) {\n\tawait requireStoreAccess();\n\n\tconst locale = await db.locale.findUnique({\n\t\twhere: { id },\n\t});\n\n\tif (!locale) {\n\t\tthrow new Error(\"Locale not found\");\n\t}\n\n\t// Unset current default\n\tawait db.locale.updateMany({\n\t\twhere: { isDefault: true },\n\t\tdata: { isDefault: false },\n\t});\n\n\t// Set new default\n\tconst updated = await db.locale.update({\n\t\twhere: { id },\n\t\tdata: { isDefault: true },\n\t});\n\n\treturn updated;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1498, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/.next-internal/server/app/%28internal%29/admin/content/blog/%5Bid%5D/edit/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getUserStores as '003bfcd7ac293af20dc22123ec44e81263e2c95347'} from 'ACTIONS_MODULE0'\nexport {userHasStore as '00b865bde8853c0b2200356e8a44aabbfda99ded8f'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {createStore as '40177cd97a285945b21e6d3751ddbdc14238608821'} from 'ACTIONS_MODULE0'\nexport {checkSlugAvailability as '40ece7c8b327f75aed046925634f22b2bd96f4eb54'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {deleteBlogPost as '40d81df54c74dd0f77bc6811c424f98f0caf2d80d1'} from 'ACTIONS_MODULE1'\nexport {getBlogPost as '40f6848fa6720c8b344249d2318350044637d70575'} from 'ACTIONS_MODULE1'\nexport {updateBlogPost as '60b1fd248f327bbc25a389733e8187a4947cca4f56'} from 'ACTIONS_MODULE1'\nexport {getOrCreateDefaultLocale as '00c21a4fde5fc4d7ea8af9814bb55639d4f312633e'} from 'ACTIONS_MODULE2'\n"],"names":[],"mappings":";AAAA;AAMA;AAGA"}}]
}