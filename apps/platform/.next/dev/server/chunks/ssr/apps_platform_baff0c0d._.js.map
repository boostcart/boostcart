{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/lib/tenant.ts"],"sourcesContent":["import type { Tenant } from \"@boostcart/database\";\nimport { db } from \"@/server/db\";\n\n// Cache for tenant lookups\nconst tenantCache = new Map<string, { tenant: Tenant; expiry: number }>();\nconst CACHE_TTL = 60 * 1000; // 1 minute\n\n/**\n * Get tenant by subdomain (slug)\n */\nexport async function getTenantBySlug(slug: string): Promise<Tenant | null> {\n\t// Check cache first\n\tconst cached = tenantCache.get(`slug:${slug}`);\n\tif (cached && cached.expiry > Date.now()) {\n\t\treturn cached.tenant;\n\t}\n\n\tconst tenant = await db.tenant.findFirst({\n\t\twhere: {\n\t\t\tslug,\n\t\t\tisActive: true,\n\t\t\tdeletedAt: null,\n\t\t},\n\t});\n\n\tif (tenant) {\n\t\ttenantCache.set(`slug:${slug}`, {\n\t\t\ttenant,\n\t\t\texpiry: Date.now() + CACHE_TTL,\n\t\t});\n\t}\n\n\treturn tenant;\n}\n\n/**\n * Get tenant by custom domain\n */\nexport async function getTenantByDomain(\n\tdomain: string,\n): Promise<Tenant | null> {\n\t// Check cache first\n\tconst cached = tenantCache.get(`domain:${domain}`);\n\tif (cached && cached.expiry > Date.now()) {\n\t\treturn cached.tenant;\n\t}\n\n\tconst tenantDomain = await db.tenantDomain.findFirst({\n\t\twhere: {\n\t\t\tdomain,\n\t\t\tdnsVerified: true,\n\t\t},\n\t\tinclude: {\n\t\t\ttenant: true,\n\t\t},\n\t});\n\n\tif (tenantDomain?.tenant && tenantDomain.tenant.isActive) {\n\t\ttenantCache.set(`domain:${domain}`, {\n\t\t\ttenant: tenantDomain.tenant,\n\t\t\texpiry: Date.now() + CACHE_TTL,\n\t\t});\n\t\treturn tenantDomain.tenant;\n\t}\n\n\treturn null;\n}\n\n/**\n * Extract tenant from request hostname\n */\nexport async function getTenantFromRequest(\n\thostname: string | null,\n): Promise<Tenant | null> {\n\tif (!hostname) return null;\n\n\t// Remove port if present\n\tconst host = hostname.split(\":\")[0];\n\tif (!host) return null;\n\n\t// Check if it's the main platform domain\n\tconst platformDomains = [\"boostcart.bg\", \"localhost\", \"127.0.0.1\"];\n\tconst isMainDomain = platformDomains.some(\n\t\t(d) => host === d || host === `www.${d}`,\n\t);\n\n\tif (isMainDomain) {\n\t\t// No tenant for main domain\n\t\treturn null;\n\t}\n\n\t// Check for subdomain (e.g., store.boostcart.bg)\n\tconst subdomainMatch = host.match(/^([a-z0-9-]+)\\.boostcart\\.bg$/i);\n\tif (subdomainMatch?.[1]) {\n\t\tconst slug = subdomainMatch[1];\n\t\t// Skip common subdomains\n\t\tif ([\"www\", \"api\", \"admin\", \"staging\", \"dev\"].includes(slug)) {\n\t\t\treturn null;\n\t\t}\n\t\treturn getTenantBySlug(slug);\n\t}\n\n\t// Check for local dev subdomain (e.g., store.localhost)\n\tconst localSubdomainMatch = host.match(/^([a-z0-9-]+)\\.localhost$/i);\n\tif (localSubdomainMatch?.[1]) {\n\t\treturn getTenantBySlug(localSubdomainMatch[1]);\n\t}\n\n\t// Otherwise, check if it's a custom domain\n\treturn getTenantByDomain(host);\n}\n\n/**\n * Clear tenant cache (useful after updates)\n */\nexport function clearTenantCache(identifier?: string) {\n\tif (identifier) {\n\t\ttenantCache.delete(`slug:${identifier}`);\n\t\ttenantCache.delete(`domain:${identifier}`);\n\t} else {\n\t\ttenantCache.clear();\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;AACA;;;;;;AAEA,2BAA2B;AAC3B,MAAM,cAAc,IAAI;AACxB,MAAM,YAAY,KAAK,MAAM,WAAW;AAKjC,eAAe,gBAAgB,IAAY;IACjD,oBAAoB;IACpB,MAAM,SAAS,YAAY,GAAG,CAAC,CAAC,KAAK,EAAE,MAAM;IAC7C,IAAI,UAAU,OAAO,MAAM,GAAG,KAAK,GAAG,IAAI;QACzC,OAAO,OAAO,MAAM;IACrB;IAEA,MAAM,SAAS,MAAM,6IAAE,CAAC,MAAM,CAAC,SAAS,CAAC;QACxC,OAAO;YACN;YACA,UAAU;YACV,WAAW;QACZ;IACD;IAEA,IAAI,QAAQ;QACX,YAAY,GAAG,CAAC,CAAC,KAAK,EAAE,MAAM,EAAE;YAC/B;YACA,QAAQ,KAAK,GAAG,KAAK;QACtB;IACD;IAEA,OAAO;AACR;AAKO,eAAe,kBACrB,MAAc;IAEd,oBAAoB;IACpB,MAAM,SAAS,YAAY,GAAG,CAAC,CAAC,OAAO,EAAE,QAAQ;IACjD,IAAI,UAAU,OAAO,MAAM,GAAG,KAAK,GAAG,IAAI;QACzC,OAAO,OAAO,MAAM;IACrB;IAEA,MAAM,eAAe,MAAM,6IAAE,CAAC,YAAY,CAAC,SAAS,CAAC;QACpD,OAAO;YACN;YACA,aAAa;QACd;QACA,SAAS;YACR,QAAQ;QACT;IACD;IAEA,IAAI,cAAc,UAAU,aAAa,MAAM,CAAC,QAAQ,EAAE;QACzD,YAAY,GAAG,CAAC,CAAC,OAAO,EAAE,QAAQ,EAAE;YACnC,QAAQ,aAAa,MAAM;YAC3B,QAAQ,KAAK,GAAG,KAAK;QACtB;QACA,OAAO,aAAa,MAAM;IAC3B;IAEA,OAAO;AACR;AAKO,eAAe,qBACrB,QAAuB;IAEvB,IAAI,CAAC,UAAU,OAAO;IAEtB,yBAAyB;IACzB,MAAM,OAAO,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE;IACnC,IAAI,CAAC,MAAM,OAAO;IAElB,yCAAyC;IACzC,MAAM,kBAAkB;QAAC;QAAgB;QAAa;KAAY;IAClE,MAAM,eAAe,gBAAgB,IAAI,CACxC,CAAC,IAAM,SAAS,KAAK,SAAS,CAAC,IAAI,EAAE,GAAG;IAGzC,IAAI,cAAc;QACjB,4BAA4B;QAC5B,OAAO;IACR;IAEA,iDAAiD;IACjD,MAAM,iBAAiB,KAAK,KAAK,CAAC;IAClC,IAAI,gBAAgB,CAAC,EAAE,EAAE;QACxB,MAAM,OAAO,cAAc,CAAC,EAAE;QAC9B,yBAAyB;QACzB,IAAI;YAAC;YAAO;YAAO;YAAS;YAAW;SAAM,CAAC,QAAQ,CAAC,OAAO;YAC7D,OAAO;QACR;QACA,OAAO,gBAAgB;IACxB;IAEA,wDAAwD;IACxD,MAAM,sBAAsB,KAAK,KAAK,CAAC;IACvC,IAAI,qBAAqB,CAAC,EAAE,EAAE;QAC7B,OAAO,gBAAgB,mBAAmB,CAAC,EAAE;IAC9C;IAEA,2CAA2C;IAC3C,OAAO,kBAAkB;AAC1B;AAKO,SAAS,iBAAiB,UAAmB;IACnD,IAAI,YAAY;QACf,YAAY,MAAM,CAAC,CAAC,KAAK,EAAE,YAAY;QACvC,YAAY,MAAM,CAAC,CAAC,OAAO,EAAE,YAAY;IAC1C,OAAO;QACN,YAAY,KAAK;IAClB;AACD"}},
    {"offset": {"line": 125, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/tenant.ts"],"sourcesContent":["\"use server\";\n\nimport type { Tenant } from \"@boostcart/database\";\nimport { headers } from \"next/headers\";\nimport { cache } from \"react\";\nimport { getTenantByDomain, getTenantBySlug } from \"@/lib/tenant\";\nimport { auth } from \"./auth\";\nimport { db } from \"./db\";\n\n/**\n * Get the current tenant from the request context (storefront)\n * This is cached per-request using React's cache()\n */\nexport const getCurrentTenant = cache(async (): Promise<Tenant | null> => {\n\tconst headersList = await headers();\n\n\t// Check for tenant slug from subdomain\n\tconst tenantSlug = headersList.get(\"x-tenant-slug\");\n\tif (tenantSlug) {\n\t\treturn getTenantBySlug(tenantSlug);\n\t}\n\n\t// Check for custom domain\n\tconst customDomain = headersList.get(\"x-custom-domain\");\n\tif (customDomain) {\n\t\treturn getTenantByDomain(customDomain);\n\t}\n\n\treturn null;\n});\n\n/**\n * Get the current tenant for admin context (from user's store ownership)\n * This is used when accessing via boostcart.bg/admin (not subdomain)\n */\nexport const getAdminTenant = cache(async (): Promise<Tenant | null> => {\n\tconst session = await auth();\n\tif (!session?.user?.id) {\n\t\treturn null;\n\t}\n\n\t// Get the user's primary store (first store they have access to)\n\tconst staffRecord = await db.tenantStaff.findFirst({\n\t\twhere: { userId: session.user.id },\n\t\tinclude: { tenant: true },\n\t\torderBy: { createdAt: \"asc\" },\n\t});\n\n\treturn staffRecord?.tenant ?? null;\n});\n\n/**\n * Require tenant to be present (storefront context), throws if not found\n */\nexport async function requireTenant(): Promise<Tenant> {\n\tconst tenant = await getCurrentTenant();\n\tif (!tenant) {\n\t\tthrow new Error(\"Tenant not found\");\n\t}\n\treturn tenant;\n}\n\n/**\n * Require tenant for admin operations\n * First checks storefront context, then falls back to user's store\n */\nexport async function requireAdminTenant(): Promise<Tenant> {\n\t// First try storefront context (subdomain access)\n\tconst storefrontTenant = await getCurrentTenant();\n\tif (storefrontTenant) {\n\t\treturn storefrontTenant;\n\t}\n\n\t// Fall back to user's store (main domain admin access)\n\tconst adminTenant = await getAdminTenant();\n\tif (adminTenant) {\n\t\treturn adminTenant;\n\t}\n\n\tthrow new Error(\"No tenant context found. Please create or select a store.\");\n}\n\n/**\n * Check if we're in a tenant context\n */\nexport async function hasTenantContext(): Promise<boolean> {\n\tconst tenant = await getCurrentTenant();\n\treturn tenant !== null;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AAGA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AAMO,MAAM,mBAAmB,IAAA,8MAAK,EAAC;IACrC,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,uCAAuC;IACvC,MAAM,aAAa,YAAY,GAAG,CAAC;IACnC,IAAI,YAAY;QACf,OAAO,IAAA,2JAAe,EAAC;IACxB;IAEA,0BAA0B;IAC1B,MAAM,eAAe,YAAY,GAAG,CAAC;IACrC,IAAI,cAAc;QACjB,OAAO,IAAA,6JAAiB,EAAC;IAC1B;IAEA,OAAO;AACR;AAMO,MAAM,iBAAiB,IAAA,8MAAK,EAAC;IACnC,MAAM,UAAU,MAAM,IAAA,0KAAI;IAC1B,IAAI,CAAC,SAAS,MAAM,IAAI;QACvB,OAAO;IACR;IAEA,iEAAiE;IACjE,MAAM,cAAc,MAAM,6IAAE,CAAC,WAAW,CAAC,SAAS,CAAC;QAClD,OAAO;YAAE,QAAQ,QAAQ,IAAI,CAAC,EAAE;QAAC;QACjC,SAAS;YAAE,QAAQ;QAAK;QACxB,SAAS;YAAE,WAAW;QAAM;IAC7B;IAEA,OAAO,aAAa,UAAU;AAC/B;AAKO,eAAe;IACrB,MAAM,SAAS,MAAM;IACrB,IAAI,CAAC,QAAQ;QACZ,MAAM,IAAI,MAAM;IACjB;IACA,OAAO;AACR;AAMO,eAAe;IACrB,kDAAkD;IAClD,MAAM,mBAAmB,MAAM;IAC/B,IAAI,kBAAkB;QACrB,OAAO;IACR;IAEA,uDAAuD;IACvD,MAAM,cAAc,MAAM;IAC1B,IAAI,aAAa;QAChB,OAAO;IACR;IAEA,MAAM,IAAI,MAAM;AACjB;AAKO,eAAe;IACrB,MAAM,SAAS,MAAM;IACrB,OAAO,WAAW;AACnB;;;IAlCsB;IAYA;IAmBA;;;;AA/BA,+OAAA;AAYA,+OAAA;AAmBA,+OAAA"}},
    {"offset": {"line": 231, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/lib/rbac.ts"],"sourcesContent":["import type { StaffRole } from \"@boostcart/database\";\n\n/**\n * Permission definitions for the BoostCart admin dashboard\n *\n * Role Hierarchy:\n * - OWNER: Full access, can manage staff, billing, delete store\n * - ADMIN: Almost full access, can manage most settings\n * - MANAGER: Can manage products, orders, customers, content\n * - SUPPORT: Can view and manage orders, customers (read-only products)\n * - VIEWER: Read-only access to everything\n */\n\nexport type Permission =\n\t// Navigation / Page Access\n\t| \"dashboard:view\"\n\t| \"orders:view\"\n\t| \"orders:manage\"\n\t| \"orders:delete\"\n\t| \"products:view\"\n\t| \"products:manage\"\n\t| \"products:delete\"\n\t| \"categories:view\"\n\t| \"categories:manage\"\n\t| \"collections:view\"\n\t| \"collections:manage\"\n\t| \"brands:view\"\n\t| \"brands:manage\"\n\t| \"gift-cards:view\"\n\t| \"gift-cards:manage\"\n\t| \"customers:view\"\n\t| \"customers:manage\"\n\t| \"customers:delete\"\n\t| \"content:view\"\n\t| \"content:manage\"\n\t| \"files:view\"\n\t| \"files:manage\"\n\t| \"discounts:view\"\n\t| \"discounts:manage\"\n\t| \"promo-codes:view\"\n\t| \"promo-codes:manage\"\n\t| \"reviews:view\"\n\t| \"reviews:manage\"\n\t| \"analytics:view\"\n\t// Settings\n\t| \"settings:view\"\n\t| \"settings:manage\"\n\t| \"locales:view\"\n\t| \"locales:manage\"\n\t| \"payments:view\"\n\t| \"payments:manage\"\n\t| \"shipping:view\"\n\t| \"shipping:manage\"\n\t// Staff management\n\t| \"staff:view\"\n\t| \"staff:manage\"\n\t| \"staff:delete\"\n\t// Billing & Store\n\t| \"billing:view\"\n\t| \"billing:manage\"\n\t| \"store:delete\";\n\n/**\n * Permission matrix: defines which permissions each role has\n */\nconst ROLE_PERMISSIONS: Record<StaffRole, Permission[]> = {\n\tOWNER: [\n\t\t// Full access to everything\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"orders:delete\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"products:delete\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"customers:delete\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"settings:manage\",\n\t\t\"locales:view\",\n\t\t\"locales:manage\",\n\t\t\"payments:view\",\n\t\t\"payments:manage\",\n\t\t\"shipping:view\",\n\t\t\"shipping:manage\",\n\t\t\"staff:view\",\n\t\t\"staff:manage\",\n\t\t\"staff:delete\",\n\t\t\"billing:view\",\n\t\t\"billing:manage\",\n\t\t\"store:delete\",\n\t],\n\n\tADMIN: [\n\t\t// Almost full access, except billing management and store deletion\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"orders:delete\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"products:delete\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"customers:delete\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"settings:manage\",\n\t\t\"locales:view\",\n\t\t\"locales:manage\",\n\t\t\"payments:view\",\n\t\t\"payments:manage\",\n\t\t\"shipping:view\",\n\t\t\"shipping:manage\",\n\t\t\"staff:view\",\n\t\t\"staff:manage\",\n\t\t\"billing:view\",\n\t],\n\n\tMANAGER: [\n\t\t// Can manage products, orders, customers, content\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"products:view\",\n\t\t\"products:manage\",\n\t\t\"categories:view\",\n\t\t\"categories:manage\",\n\t\t\"collections:view\",\n\t\t\"collections:manage\",\n\t\t\"brands:view\",\n\t\t\"brands:manage\",\n\t\t\"gift-cards:view\",\n\t\t\"gift-cards:manage\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"content:view\",\n\t\t\"content:manage\",\n\t\t\"files:view\",\n\t\t\"files:manage\",\n\t\t\"discounts:view\",\n\t\t\"discounts:manage\",\n\t\t\"promo-codes:view\",\n\t\t\"promo-codes:manage\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"locales:view\",\n\t\t\"payments:view\",\n\t\t\"shipping:view\",\n\t],\n\n\tSUPPORT: [\n\t\t// Can view most things, manage orders and customers only\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"orders:manage\",\n\t\t\"products:view\",\n\t\t\"categories:view\",\n\t\t\"collections:view\",\n\t\t\"brands:view\",\n\t\t\"gift-cards:view\",\n\t\t\"customers:view\",\n\t\t\"customers:manage\",\n\t\t\"content:view\",\n\t\t\"files:view\",\n\t\t\"discounts:view\",\n\t\t\"promo-codes:view\",\n\t\t\"reviews:view\",\n\t\t\"reviews:manage\",\n\t],\n\n\tVIEWER: [\n\t\t// Read-only access\n\t\t\"dashboard:view\",\n\t\t\"orders:view\",\n\t\t\"products:view\",\n\t\t\"categories:view\",\n\t\t\"collections:view\",\n\t\t\"brands:view\",\n\t\t\"gift-cards:view\",\n\t\t\"customers:view\",\n\t\t\"content:view\",\n\t\t\"files:view\",\n\t\t\"discounts:view\",\n\t\t\"promo-codes:view\",\n\t\t\"reviews:view\",\n\t\t\"analytics:view\",\n\t\t\"settings:view\",\n\t\t\"locales:view\",\n\t\t\"payments:view\",\n\t\t\"shipping:view\",\n\t],\n};\n\n/**\n * Check if a role has a specific permission\n */\nexport function hasPermission(\n\trole: StaffRole | string | null,\n\tpermission: Permission\n): boolean {\n\tif (!role) return false;\n\tconst permissions = ROLE_PERMISSIONS[role as StaffRole];\n\tif (!permissions) return false;\n\treturn permissions.includes(permission);\n}\n\n/**\n * Check if a role has any of the specified permissions\n */\nexport function hasAnyPermission(\n\trole: StaffRole | string | null,\n\tpermissions: Permission[]\n): boolean {\n\treturn permissions.some((permission) => hasPermission(role, permission));\n}\n\n/**\n * Check if a role has all of the specified permissions\n */\nexport function hasAllPermissions(\n\trole: StaffRole | string | null,\n\tpermissions: Permission[]\n): boolean {\n\treturn permissions.every((permission) => hasPermission(role, permission));\n}\n\n/**\n * Get all permissions for a role\n */\nexport function getPermissions(role: StaffRole | string | null): Permission[] {\n\tif (!role) return [];\n\treturn ROLE_PERMISSIONS[role as StaffRole] || [];\n}\n\n/**\n * Check if role can manage (create/edit/delete) a resource\n */\nexport function canManage(\n\trole: StaffRole | string | null,\n\tresource:\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): boolean {\n\treturn hasPermission(role, `${resource}:manage` as Permission);\n}\n\n/**\n * Check if role can view a resource\n */\nexport function canView(\n\trole: StaffRole | string | null,\n\tresource:\n\t\t| \"dashboard\"\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"analytics\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): boolean {\n\treturn hasPermission(role, `${resource}:view` as Permission);\n}\n\n/**\n * Check if role can delete a resource\n */\nexport function canDelete(\n\trole: StaffRole | string | null,\n\tresource: \"orders\" | \"products\" | \"customers\" | \"staff\" | \"store\"\n): boolean {\n\treturn hasPermission(role, `${resource}:delete` as Permission);\n}\n\n/**\n * Role hierarchy for comparison\n * Higher number = more authority\n */\nconst ROLE_HIERARCHY: Record<StaffRole, number> = {\n\tOWNER: 100,\n\tADMIN: 80,\n\tMANAGER: 60,\n\tSUPPORT: 40,\n\tVIEWER: 20,\n};\n\n/**\n * Check if roleA has higher or equal authority than roleB\n */\nexport function hasHigherOrEqualAuthority(\n\troleA: StaffRole | string | null,\n\troleB: StaffRole | string | null\n): boolean {\n\tif (!roleA || !roleB) return false;\n\tconst levelA = ROLE_HIERARCHY[roleA as StaffRole] || 0;\n\tconst levelB = ROLE_HIERARCHY[roleB as StaffRole] || 0;\n\treturn levelA >= levelB;\n}\n\n/**\n * Get display name for a role\n */\nexport function getRoleDisplayName(role: StaffRole | string | null): string {\n\tswitch (role) {\n\t\tcase \"OWNER\":\n\t\t\treturn \"Owner\";\n\t\tcase \"ADMIN\":\n\t\t\treturn \"Administrator\";\n\t\tcase \"MANAGER\":\n\t\t\treturn \"Manager\";\n\t\tcase \"SUPPORT\":\n\t\t\treturn \"Support\";\n\t\tcase \"VIEWER\":\n\t\t\treturn \"Viewer\";\n\t\tdefault:\n\t\t\treturn \"Unknown\";\n\t}\n}\n\n/**\n * Get role description\n */\nexport function getRoleDescription(role: StaffRole | string | null): string {\n\tswitch (role) {\n\t\tcase \"OWNER\":\n\t\t\treturn \"Full access to everything including billing and staff management\";\n\t\tcase \"ADMIN\":\n\t\t\treturn \"Manage all store operations except billing\";\n\t\tcase \"MANAGER\":\n\t\t\treturn \"Manage products, orders, customers, and content\";\n\t\tcase \"SUPPORT\":\n\t\t\treturn \"Handle customer orders and inquiries\";\n\t\tcase \"VIEWER\":\n\t\t\treturn \"View-only access to store data\";\n\t\tdefault:\n\t\t\treturn \"Unknown role\";\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AA8DA;;CAEC,GACD,MAAM,mBAAoD;IACzD,OAAO;QACN,4BAA4B;QAC5B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,OAAO;QACN,mEAAmE;QACnE;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,SAAS;QACR,kDAAkD;QAClD;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,SAAS;QACR,yDAAyD;QACzD;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;IAED,QAAQ;QACP,mBAAmB;QACnB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA;AACF;AAKO,SAAS,cACf,IAA+B,EAC/B,UAAsB;IAEtB,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,cAAc,gBAAgB,CAAC,KAAkB;IACvD,IAAI,CAAC,aAAa,OAAO;IACzB,OAAO,YAAY,QAAQ,CAAC;AAC7B;AAKO,SAAS,iBACf,IAA+B,EAC/B,WAAyB;IAEzB,OAAO,YAAY,IAAI,CAAC,CAAC,aAAe,cAAc,MAAM;AAC7D;AAKO,SAAS,kBACf,IAA+B,EAC/B,WAAyB;IAEzB,OAAO,YAAY,KAAK,CAAC,CAAC,aAAe,cAAc,MAAM;AAC9D;AAKO,SAAS,eAAe,IAA+B;IAC7D,IAAI,CAAC,MAAM,OAAO,EAAE;IACpB,OAAO,gBAAgB,CAAC,KAAkB,IAAI,EAAE;AACjD;AAKO,SAAS,UACf,IAA+B,EAC/B,QAkBY;IAEZ,OAAO,cAAc,MAAM,GAAG,SAAS,OAAO,CAAC;AAChD;AAKO,SAAS,QACf,IAA+B,EAC/B,QAoBY;IAEZ,OAAO,cAAc,MAAM,GAAG,SAAS,KAAK,CAAC;AAC9C;AAKO,SAAS,UACf,IAA+B,EAC/B,QAAiE;IAEjE,OAAO,cAAc,MAAM,GAAG,SAAS,OAAO,CAAC;AAChD;AAEA;;;CAGC,GACD,MAAM,iBAA4C;IACjD,OAAO;IACP,OAAO;IACP,SAAS;IACT,SAAS;IACT,QAAQ;AACT;AAKO,SAAS,0BACf,KAAgC,EAChC,KAAgC;IAEhC,IAAI,CAAC,SAAS,CAAC,OAAO,OAAO;IAC7B,MAAM,SAAS,cAAc,CAAC,MAAmB,IAAI;IACrD,MAAM,SAAS,cAAc,CAAC,MAAmB,IAAI;IACrD,OAAO,UAAU;AAClB;AAKO,SAAS,mBAAmB,IAA+B;IACjE,OAAQ;QACP,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR;YACC,OAAO;IACT;AACD;AAKO,SAAS,mBAAmB,IAA+B;IACjE,OAAQ;QACP,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR,KAAK;YACJ,OAAO;QACR;YACC,OAAO;IACT;AACD"}},
    {"offset": {"line": 498, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/permissions.ts"],"sourcesContent":["\"use server\";\n\nimport { db } from \"@/server/db\";\nimport { auth } from \"@/server/auth\";\nimport { requireAdminTenant } from \"@/server/tenant\";\nimport type { StaffRole } from \"@boostcart/database\";\nimport {\n\thasPermission,\n\thasAnyPermission,\n\thasAllPermissions,\n\tcanManage,\n\tcanView,\n\tcanDelete,\n\ttype Permission,\n} from \"@/lib/rbac\";\n\ninterface StaffContext {\n\tuserId: string;\n\ttenantId: string;\n\trole: StaffRole;\n}\n\n/**\n * Get the current staff context (user, tenant, role)\n * Throws an error if the user is not authenticated or not a staff member\n */\nexport async function getStaffContext(): Promise<StaffContext> {\n\tconst session = await auth();\n\n\tif (!session?.user?.id) {\n\t\tthrow new Error(\"Unauthorized: Not authenticated\");\n\t}\n\n\t// Get tenant context (from subdomain or user's store membership)\n\tconst tenant = await requireAdminTenant();\n\n\t// Get staff record\n\tconst staff = await db.tenantStaff.findFirst({\n\t\twhere: {\n\t\t\tuserId: session.user.id,\n\t\t\ttenantId: tenant.id,\n\t\t},\n\t\tselect: {\n\t\t\trole: true,\n\t\t},\n\t});\n\n\tif (!staff) {\n\t\tthrow new Error(\"Unauthorized: Not a staff member of this tenant\");\n\t}\n\n\treturn {\n\t\tuserId: session.user.id,\n\t\ttenantId: tenant.id,\n\t\trole: staff.role,\n\t};\n}\n\n/**\n * Require a specific permission to continue\n * Throws an error if the user doesn't have the required permission\n */\nexport async function requirePermission(permission: Permission): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasPermission(context.role, permission)) {\n\t\tthrow new Error(`Forbidden: Missing permission '${permission}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require any of the specified permissions\n */\nexport async function requireAnyPermission(permissions: Permission[]): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasAnyPermission(context.role, permissions)) {\n\t\tthrow new Error(`Forbidden: Missing required permissions`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require all of the specified permissions\n */\nexport async function requireAllPermissions(permissions: Permission[]): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!hasAllPermissions(context.role, permissions)) {\n\t\tthrow new Error(`Forbidden: Missing required permissions`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to manage a resource\n */\nexport async function requireManagePermission(\n\tresource:\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canManage(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot manage '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to view a resource\n */\nexport async function requireViewPermission(\n\tresource:\n\t\t| \"dashboard\"\n\t\t| \"orders\"\n\t\t| \"products\"\n\t\t| \"categories\"\n\t\t| \"collections\"\n\t\t| \"brands\"\n\t\t| \"gift-cards\"\n\t\t| \"customers\"\n\t\t| \"content\"\n\t\t| \"files\"\n\t\t| \"discounts\"\n\t\t| \"promo-codes\"\n\t\t| \"reviews\"\n\t\t| \"analytics\"\n\t\t| \"settings\"\n\t\t| \"locales\"\n\t\t| \"payments\"\n\t\t| \"shipping\"\n\t\t| \"staff\"\n\t\t| \"billing\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canView(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot view '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Require ability to delete a resource\n */\nexport async function requireDeletePermission(\n\tresource: \"orders\" | \"products\" | \"customers\" | \"staff\" | \"store\"\n): Promise<StaffContext> {\n\tconst context = await getStaffContext();\n\n\tif (!canDelete(context.role, resource)) {\n\t\tthrow new Error(`Forbidden: Cannot delete '${resource}'`);\n\t}\n\n\treturn context;\n}\n\n/**\n * Check if current user has a permission (doesn't throw)\n */\nexport async function checkPermission(permission: Permission): Promise<boolean> {\n\ttry {\n\t\tconst context = await getStaffContext();\n\t\treturn hasPermission(context.role, permission);\n\t} catch {\n\t\treturn false;\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;AAoBO,eAAe;IACrB,MAAM,UAAU,MAAM,IAAA,0KAAI;IAE1B,IAAI,CAAC,SAAS,MAAM,IAAI;QACvB,MAAM,IAAI,MAAM;IACjB;IAEA,iEAAiE;IACjE,MAAM,SAAS,MAAM,IAAA,iKAAkB;IAEvC,mBAAmB;IACnB,MAAM,QAAQ,MAAM,6IAAE,CAAC,WAAW,CAAC,SAAS,CAAC;QAC5C,OAAO;YACN,QAAQ,QAAQ,IAAI,CAAC,EAAE;YACvB,UAAU,OAAO,EAAE;QACpB;QACA,QAAQ;YACP,MAAM;QACP;IACD;IAEA,IAAI,CAAC,OAAO;QACX,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;QACN,QAAQ,QAAQ,IAAI,CAAC,EAAE;QACvB,UAAU,OAAO,EAAE;QACnB,MAAM,MAAM,IAAI;IACjB;AACD;AAMO,eAAe,kBAAkB,UAAsB;IAC7D,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,uJAAa,EAAC,QAAQ,IAAI,EAAE,aAAa;QAC7C,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,WAAW,CAAC,CAAC;IAChE;IAEA,OAAO;AACR;AAKO,eAAe,qBAAqB,WAAyB;IACnE,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,0JAAgB,EAAC,QAAQ,IAAI,EAAE,cAAc;QACjD,MAAM,IAAI,MAAM,CAAC,uCAAuC,CAAC;IAC1D;IAEA,OAAO;AACR;AAKO,eAAe,sBAAsB,WAAyB;IACpE,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,2JAAiB,EAAC,QAAQ,IAAI,EAAE,cAAc;QAClD,MAAM,IAAI,MAAM,CAAC,uCAAuC,CAAC;IAC1D;IAEA,OAAO;AACR;AAKO,eAAe,wBACrB,QAkBY;IAEZ,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,mJAAS,EAAC,QAAQ,IAAI,EAAE,WAAW;QACvC,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,SAAS,CAAC,CAAC;IACzD;IAEA,OAAO;AACR;AAKO,eAAe,sBACrB,QAoBY;IAEZ,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,iJAAO,EAAC,QAAQ,IAAI,EAAE,WAAW;QACrC,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,SAAS,CAAC,CAAC;IACvD;IAEA,OAAO;AACR;AAKO,eAAe,wBACrB,QAAiE;IAEjE,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,IAAA,mJAAS,EAAC,QAAQ,IAAI,EAAE,WAAW;QACvC,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,SAAS,CAAC,CAAC;IACzD;IAEA,OAAO;AACR;AAKO,eAAe,gBAAgB,UAAsB;IAC3D,IAAI;QACH,MAAM,UAAU,MAAM;QACtB,OAAO,IAAA,uJAAa,EAAC,QAAQ,IAAI,EAAE;IACpC,EAAE,OAAM;QACP,OAAO;IACR;AACD;;;IArKsB;IAoCA;IAaA;IAaA;IAaA;IAiCA;IAmCA;IAeA;;AA9JA,+OAAA;AAoCA,+OAAA;AAaA,+OAAA;AAaA,+OAAA;AAaA,+OAAA;AAiCA,+OAAA;AAmCA,+OAAA;AAeA,+OAAA"}},
    {"offset": {"line": 635, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/src/server/api/internal/domains.ts"],"sourcesContent":["\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { db } from \"@/server/db\";\nimport {\n\trequireManagePermission,\n\trequireViewPermission,\n} from \"@/server/api/permissions\";\nimport { z } from \"zod\";\n\n// Validation schemas\nconst AddDomainSchema = z.object({\n\tdomain: z\n\t\t.string()\n\t\t.min(1, \"Domain is required\")\n\t\t.regex(\n\t\t\t/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,}$/,\n\t\t\t\"Invalid domain format\"\n\t\t)\n\t\t.transform((d) => d.toLowerCase()),\n});\n\n// Get all custom domains for the current tenant\nexport async function getDomains() {\n\tconst { tenantId } = await requireViewPermission(\"settings\");\n\n\tconst domains = await db.tenantDomain.findMany({\n\t\twhere: { tenantId },\n\t\torderBy: [{ isPrimary: \"desc\" }, { createdAt: \"asc\" }],\n\t});\n\n\treturn domains;\n}\n\n// Get a single domain by ID\nexport async function getDomain(domainId: string) {\n\tconst { tenantId } = await requireViewPermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\treturn domain;\n}\n\n// Add a new custom domain\nexport async function addDomain(input: { domain: string }) {\n\tconst { tenantId } = await requireManagePermission(\"settings\");\n\n\tconst validated = AddDomainSchema.parse(input);\n\n\t// Check if domain already exists (globally)\n\tconst existingDomain = await db.tenantDomain.findUnique({\n\t\twhere: { domain: validated.domain },\n\t});\n\n\tif (existingDomain) {\n\t\tthrow new Error(\"This domain is already in use\");\n\t}\n\n\t// Check domain limit (e.g., max 5 custom domains per tenant)\n\tconst domainCount = await db.tenantDomain.count({\n\t\twhere: { tenantId },\n\t});\n\n\tif (domainCount >= 5) {\n\t\tthrow new Error(\"Maximum number of custom domains reached (5)\");\n\t}\n\n\t// Create the domain with a verification token\n\tconst domain = await db.tenantDomain.create({\n\t\tdata: {\n\t\t\ttenantId,\n\t\t\tdomain: validated.domain,\n\t\t\tisPrimary: domainCount === 0, // First domain is primary\n\t\t\tsslStatus: \"pending\",\n\t\t\tdnsVerified: false,\n\t\t},\n\t});\n\n\trevalidatePath(\"/admin/settings/domains\");\n\n\treturn domain;\n}\n\n// Remove a custom domain\nexport async function removeDomain(domainId: string) {\n\tconst { tenantId } = await requireManagePermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\t// Don't allow removing the primary domain if others exist\n\tif (domain.isPrimary) {\n\t\tconst otherDomains = await db.tenantDomain.count({\n\t\t\twhere: { tenantId, id: { not: domainId } },\n\t\t});\n\n\t\tif (otherDomains > 0) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Cannot remove primary domain. Set another domain as primary first.\"\n\t\t\t);\n\t\t}\n\t}\n\n\tawait db.tenantDomain.delete({\n\t\twhere: { id: domainId },\n\t});\n\n\trevalidatePath(\"/admin/settings/domains\");\n\n\treturn { success: true };\n}\n\n// Set a domain as primary\nexport async function setPrimaryDomain(domainId: string) {\n\tconst { tenantId } = await requireManagePermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\tif (!domain.dnsVerified) {\n\t\tthrow new Error(\"Domain must be verified before setting as primary\");\n\t}\n\n\t// Update all domains: unset current primary, set new primary\n\tawait db.$transaction([\n\t\tdb.tenantDomain.updateMany({\n\t\t\twhere: { tenantId, isPrimary: true },\n\t\t\tdata: { isPrimary: false },\n\t\t}),\n\t\tdb.tenantDomain.update({\n\t\t\twhere: { id: domainId },\n\t\t\tdata: { isPrimary: true },\n\t\t}),\n\t]);\n\n\trevalidatePath(\"/admin/settings/domains\");\n\n\treturn { success: true };\n}\n\n// Verify domain DNS records\nexport async function verifyDomain(domainId: string) {\n\tconst { tenantId } = await requireManagePermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\t// Perform DNS verification\n\tconst isVerified = await checkDnsVerification(domain.domain, domain.dnsToken);\n\n\tif (isVerified) {\n\t\tawait db.tenantDomain.update({\n\t\t\twhere: { id: domainId },\n\t\t\tdata: {\n\t\t\t\tdnsVerified: true,\n\t\t\t\tsslStatus: \"provisioning\", // SSL will be provisioned by Vercel/Cloudflare\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(\"/admin/settings/domains\");\n\n\t\treturn { success: true, verified: true };\n\t}\n\n\treturn { success: true, verified: false };\n}\n\n// Refresh verification token\nexport async function refreshDnsToken(domainId: string) {\n\tconst { tenantId } = await requireManagePermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\t// Generate a new token by updating the record (cuid will auto-generate)\n\tconst updated = await db.tenantDomain.update({\n\t\twhere: { id: domainId },\n\t\tdata: {\n\t\t\tdnsToken: generateVerificationToken(),\n\t\t\tdnsVerified: false,\n\t\t},\n\t});\n\n\trevalidatePath(\"/admin/settings/domains\");\n\n\treturn updated;\n}\n\n// Helper function to check DNS TXT record\nasync function checkDnsVerification(\n\tdomain: string,\n\texpectedToken: string\n): Promise<boolean> {\n\ttry {\n\t\t// Use DNS over HTTPS (Cloudflare) for verification\n\t\tconst response = await fetch(\n\t\t\t`https://cloudflare-dns.com/dns-query?name=_boostcart-verification.${domain}&type=TXT`,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAccept: \"application/dns-json\",\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\tif (!response.ok) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst data = await response.json();\n\n\t\tif (!data.Answer || !Array.isArray(data.Answer)) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check if any TXT record contains our verification token\n\t\tfor (const answer of data.Answer) {\n\t\t\tif (answer.type === 16) {\n\t\t\t\t// TXT record type\n\t\t\t\tconst txtValue = answer.data?.replace(/\"/g, \"\");\n\t\t\t\tif (txtValue === `boostcart-verify=${expectedToken}`) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t} catch (error) {\n\t\tconsole.error(\"DNS verification error:\", error);\n\t\treturn false;\n\t}\n}\n\n// Helper function to generate verification token\nfunction generateVerificationToken(): string {\n\tconst chars = \"abcdefghijklmnopqrstuvwxyz0123456789\";\n\tlet token = \"\";\n\tfor (let i = 0; i < 32; i++) {\n\t\ttoken += chars.charAt(Math.floor(Math.random() * chars.length));\n\t}\n\treturn token;\n}\n\n// Get verification instructions for a domain\nexport async function getDomainVerificationInstructions(domainId: string) {\n\tconst { tenantId } = await requireViewPermission(\"settings\");\n\n\tconst domain = await db.tenantDomain.findFirst({\n\t\twhere: { id: domainId, tenantId },\n\t});\n\n\tif (!domain) {\n\t\tthrow new Error(\"Domain not found\");\n\t}\n\n\treturn {\n\t\tdomain: domain.domain,\n\t\tdnsToken: domain.dnsToken,\n\t\tverified: domain.dnsVerified,\n\t\tinstructions: {\n\t\t\ttype: \"TXT\",\n\t\t\thost: `_boostcart-verification.${domain.domain}`,\n\t\t\tvalue: `boostcart-verify=${domain.dnsToken}`,\n\t\t\tttl: 3600,\n\t\t\tcname: {\n\t\t\t\thost: domain.domain,\n\t\t\t\tvalue: \"cname.boostcart.bg\",\n\t\t\t},\n\t\t},\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 963, "column": 0}, "map": {"version":3,"sources":["file:///Users/bobkata/Projects/boostcart/apps/platform/.next-internal/server/app/%28internal%29/admin/settings/domains/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getUserStores as '003bfcd7ac293af20dc22123ec44e81263e2c95347'} from 'ACTIONS_MODULE0'\nexport {userHasStore as '00b865bde8853c0b2200356e8a44aabbfda99ded8f'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {createStore as '40177cd97a285945b21e6d3751ddbdc14238608821'} from 'ACTIONS_MODULE0'\nexport {checkSlugAvailability as '40ece7c8b327f75aed046925634f22b2bd96f4eb54'} from 'ACTIONS_MODULE0'\nexport {getCurrentTenant as '00f61908051b9076d3d4981917b5b0f4b9a64a3f03'} from 'ACTIONS_MODULE0'\nexport {addDomain as '40e9db0f701fb5732c69ea6fc1a7e77244d5237ab6'} from 'ACTIONS_MODULE1'\nexport {getDomainVerificationInstructions as '400cabd68b4758a91a7e4b77cbe129dfbf0f92627b'} from 'ACTIONS_MODULE1'\nexport {getDomains as '0039aec277912afd4d01246ac7ba2e72032eb260d6'} from 'ACTIONS_MODULE1'\nexport {refreshDnsToken as '40cc31663a422896f468a3f28d2a20f5fe65de730b'} from 'ACTIONS_MODULE1'\nexport {removeDomain as '4095bfdbff7509e269d164352ff3e406f53a8bc2a2'} from 'ACTIONS_MODULE1'\nexport {setPrimaryDomain as '405fa7bfc89c3d069e3466cebb96251ed386e72bac'} from 'ACTIONS_MODULE1'\nexport {verifyDomain as '40335ab5226bd948dde18f66fa41d2c6a492e3f2b0'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAMA"}}]
}